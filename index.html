<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ucieczka z Mrocznego Lasu - FINAL PC/MOBILE</title>
    <style>
        body { margin: 0; overflow: hidden; background: black; font-family: 'Courier New', Courier, monospace; color: white; user-select: none; touch-action: none; }
        
        #introWarning { position: absolute; width: 100%; height: 100%; background: black; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        #acceptWarningBtn { pointer-events: none; opacity: 0; transition: opacity 1s; padding: 15px 30px; font-size: 20px; font-weight: bold; background: red; color: white; border: none; cursor: pointer; border-radius: 5px; margin-top: 30px;}
        #acceptWarningBtn:hover { background: darkred; }

        #calibrationScreen { display: none; position: absolute; width: 100%; height: 100%; background: black; z-index: 900; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        #firstJumpscare { display: none; position: absolute; width: 100%; height: 100%; background: black; z-index: 2000; background-image: url('jumpscarefirst.gif'); background-size: contain; background-repeat: no-repeat; background-position: center; }
        #gameJumpscare { display: none; position: absolute; width: 100%; height: 100%; background: black; z-index: 2000; background-image: url('jumpscare.png'); background-size: contain; background-repeat: no-repeat; background-position: center; }
        
        #blocker { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        #instructions { font-size: 24px; cursor: pointer; text-align: center; padding: 20px; }
        
        #ui { position: absolute; top: 10px; left: 10px; z-index: 50; font-size: 20px; text-shadow: 2px 2px 2px black; pointer-events: none; }
        .ui-item { margin-bottom: 5px; }
        #buffsContainer { margin-top: 15px; font-weight: bold; }
        .buff-speed { color: yellow; display: none; }
        .buff-tracker { color: red; display: none; }
        .debuff-bush { color: purple; display: none; } 

        #crosshair { position: absolute; top: 50%; left: 50%; width: 10px; height: 10px; background: white; border-radius: 50%; transform: translate(-50%, -50%); z-index: 50; pointer-events: none; }
        
        .overlay { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(20, 20, 20, 0.95); padding: 30px; border: 2px solid white; z-index: 200; text-align: center; border-radius: 10px; }
        input[type="text"] { background: black; color: white; border: 1px solid white; padding: 10px; font-size: 16px; width: 80%; cursor: text; }
        button { background: white; color: black; border: none; padding: 10px 20px; font-size: 18px; cursor: pointer; margin-top: 10px; }
        button:hover { background: gray; }
        button:disabled { background: #333; color: #666; cursor: not-allowed; }
        #secretInput { margin-top: 20px; font-size: 12px; cursor: default; }
        
        #gdCanvas { border: 2px solid white; background: #222; margin-top: 10px; display: none; cursor: crosshair; }
        #osuCanvas { border: 2px solid white; background: #111; margin-top: 10px; display: block; }

        /* --- MOBILE CONTROLS (Tylko na telefonie) --- */
        #mobileControls { display: none; position: absolute; width: 100%; height: 100%; top: 0; left: 0; z-index: 150; pointer-events: none; }
        #joystickZone { position: absolute; bottom: 50px; left: 50px; width: 150px; height: 150px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); pointer-events: auto; }
        #joystickKnob { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; background: rgba(255, 255, 255, 0.5); border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; }
        #actionButtons { position: absolute; bottom: 30px; right: 30px; display: flex; gap: 15px; pointer-events: auto; flex-direction: column-reverse; align-items: flex-end; }
        .mob-btn { width: 70px; height: 70px; background: rgba(255, 255, 255, 0.2); border: 2px solid white; border-radius: 50%; color: white; font-size: 30px; display: flex; justify-content: center; align-items: center; touch-action: manipulation; user-select: none; }
        .mob-btn:active { background: rgba(255, 255, 255, 0.5); }
        .mob-btn-big { width: 90px; height: 90px; font-size: 40px; background: rgba(255, 0, 0, 0.3); }
        #lookZone { position: absolute; top: 0; right: 0; width: 50%; height: 70%; z-index: 140; pointer-events: auto; }
    </style>
</head>
<body>
    <div id="introWarning">
        <h1 style="color: red;">‚ö†Ô∏è OSTRZE≈ªENIE ‚ö†Ô∏è</h1>
        <p>Ta gra zawiera nag≈Çe, g≈Ço≈õne d≈∫wiƒôki oraz jumpscare'y.</p>
        <button id="acceptWarningBtn">DOTKNIJ ABY ROZPOCZƒÑƒÜ</button>
        <p style="margin-top: 20px; color: gray;">[PC: ENTER | Mobile: Dotknij, aby pominƒÖƒá]</p>
    </div>

    <div id="calibrationScreen">
        <h2>Krok 1: Kalibracja D≈∫wiƒôku</h2>
        <p>Podkrƒôƒá g≈Ço≈õno≈õƒá w s≈Çuchawkach, a≈º us≈Çyszysz ciche cykanie ≈õwierszczy...</p>
        <p style="margin-top: 30px; color: gray;">Kalibracja trwa: <span id="calibTimer">0</span>%</p>
    </div>

    <div id="firstJumpscare"></div>
    <div id="gameJumpscare"></div>

    <div id="ui">
        <div class="ui-item">üí∞ Monety: <span id="coinCount">0</span>/250</div>
        <div class="ui-item">üß© Przyciski: <span id="btnCount">0</span>/3</div>
        <div id="buffsContainer">
            <div id="uiSpeed" class="buff-speed">‚ö° Szybko≈õƒá: <span id="speedTimeText">60</span>s</div>
            <div id="uiTracker" class="buff-tracker">üëÅÔ∏è Lokalizator: <span id="trackerTimeText">10</span>s</div>
            <div id="uiBushCD" class="debuff-bush">üö´ Krzaki Zablokowane: <span id="bushTimeText">180</span>s</div>
        </div>
    </div>

    <div id="mobileControls">
        <div id="joystickZone"><div id="joystickKnob"></div></div>
        <div id="actionButtons">
            <div class="mob-btn" id="btnJump">‚¨ÜÔ∏è</div>
            <div class="mob-btn mob-btn-big" id="btnInteract">üñêÔ∏è</div>
            <div class="mob-btn" id="btnSprint">üèÉ</div>
        </div>
    </div>
    <div id="lookZone"></div>

    <div id="crosshair"></div>

    <div id="blocker">
        <div id="instructions">
            <h1 id="mainTitle">Mroczny Las</h1>
            <p>Kliknij / Dotknij, aby graƒá</p>
            <p id="pcControls" style="font-size: 14px;">WSAD - Ruch | SHIFT - Sprint | SPACJA - Skok | E - Interakcja</p>
            <div id="secretInput">
                <p>???</p>
                <input type="text" id="secretCode" placeholder="Wpisz kod..." maxlength="5">
                <button onclick="checkSecret()">Zastosuj</button>
            </div>
        </div>
    </div>

    <div id="puzzle1" class="overlay"><h2>Zagadka #1</h2><p>Masz 20 sekund!</p><input type="text" id="ans1"><button onclick="solvePuzzle1()">Zatwierd≈∫</button><p id="timer1" style="color: red;">20</p></div>
    <div id="puzzle2" class="overlay"><h2>Zagadka #2</h2><video id="puzzleVideo" width="300" height="200" controls></video><input type="text" id="ans2"><button onclick="solvePuzzle2()">Zatwierd≈∫</button><p id="timer2" style="color: red;">20</p></div>
    <div id="puzzle3" class="overlay"><h2>Zagadka #3 - Wave</h2><canvas id="gdCanvas" width="400" height="300"></canvas><button id="startGdBtn" onclick="startGD()">Start</button><p id="timer3" style="color: red;"></p></div>
    <div id="osuOverlay" class="overlay"><h2 style="color: lime;">ü§´ Cicho!</h2><p>Trafiaj w nuty!</p><p>Celno≈õƒá: <span id="osuAcc">100</span>%</p><canvas id="osuCanvas" width="400" height="500"></canvas></div>
    <div id="shop" class="overlay"><h2>Sklep</h2><p>Monety: <span id="shopCoins"></span></p><button onclick="buySpeed()">Szybko≈õƒá (10g)</button><button onclick="buyTracker()">Lokalizator (10g)</button><button onclick="closeShop()">Wyjd≈∫</button></div>
    <div id="endScreen" class="overlay"><h1 id="endTitle">Koniec!</h1><p id="endSubtitle"></p><button onclick="location.reload()">Zagraj Ponownie</button></div>

    <audio id="sndCrickets" src="crickets.mp3" loop preload="auto"></audio>
    <audio id="sndFakeJumpscare" src="jumpscarefirstsound.mp3" preload="auto"></audio>
    <audio id="sndRealJumpscare" src="jumpscaresound.mp3" preload="auto"></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/PointerLockControls.js"></script>

<script>
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
if(isMobile) { document.getElementById('mobileControls').style.display = 'block'; document.getElementById('pcControls').innerText = "Sterowanie dotykowe aktywne"; }

function stopAllGameSounds() { if(ambientAudio && ambientAudio.isPlaying) ambientAudio.stop(); if(nextbotAudio && nextbotAudio.isPlaying) nextbotAudio.stop(); if(agroAudio && agroAudio.isPlaying) agroAudio.stop(); let c = document.getElementById('sndCrickets'); c.pause(); c.currentTime=0; let f = document.getElementById('sndFakeJumpscare'); f.pause(); f.currentTime=0; }

let introFinished = false; let calibInterval; let calibTimeout1; let calibTimeout2;
setTimeout(() => { const btn = document.getElementById('acceptWarningBtn'); btn.style.pointerEvents = "auto"; btn.style.opacity = "1"; }, 3000);
document.getElementById('acceptWarningBtn').addEventListener('click', function() { document.getElementById('introWarning').style.display = 'none'; startCalibration(); });

function skipIntro() { if(introFinished) return; clearInterval(calibInterval); clearTimeout(calibTimeout1); clearTimeout(calibTimeout2); stopAllGameSounds(); document.getElementById('introWarning').style.display = 'none'; document.getElementById('calibrationScreen').style.display = 'none'; document.getElementById('firstJumpscare').style.display = 'none'; document.getElementById('blocker').style.display = 'flex'; introFinished = true; animate(); }
window.addEventListener('keydown', function(e) { if (e.code === 'Enter' && !introFinished) skipIntro(); });
document.getElementById('calibrationScreen').addEventListener('touchstart', skipIntro);

function startCalibration() { document.getElementById('calibrationScreen').style.display = 'flex'; let c = document.getElementById('sndCrickets'); c.volume = 0.1; c.play().catch(e=>console.warn(e)); let p = 0; calibInterval = setInterval(() => { p += Math.floor(Math.random() * 5); if(p>99) p=99; document.getElementById('calibTimer').innerText = p; }, 700); calibTimeout1 = setTimeout(() => { clearInterval(calibInterval); c.pause(); c.currentTime = 0; document.getElementById('calibrationScreen').style.display = 'none'; document.getElementById('firstJumpscare').style.display = 'block'; let l = document.getElementById('sndFakeJumpscare'); l.volume = 1.0; l.play().catch(e=>console.warn(e)); calibTimeout2 = setTimeout(() => { l.pause(); l.currentTime = 0; document.getElementById('firstJumpscare').style.display = 'none'; document.getElementById('blocker').style.display = 'flex'; introFinished = true; animate(); }, 2500); }, 15000); }

let isSecretMode = false; let gameWon = false; let hasFlashlight = false; let flashlightSpot; let buttonsFound = 0; let coinsCollected = 0; let isAggro = false; let nextbotTrackerActive = false; let gameStarted = false; let speedTimeLeft = 0; let trackerTimeLeft = 0; let speedMult = 1.0; let bushCooldownTime = 0; let isHiding = false; let isSprinting = false; let velocityY = 0; const gravity = -30.0; const jumpStrength = 12.0; let canJump = false; 
const gridCellSize = 20; const treeCollisionGrid = {}; function getGridKey(x, z) { return Math.floor(x / gridCellSize) + "_" + Math.floor(z / gridCellSize); }
let assets = { nextbotImg: 'nextbot.jpg', nextbotSound: 'nextbotsound.mp3', agroSound: 'agro.mp3', puzzle1Sound: 'zagadka1.mp3', puzzle2Video: 'wideo.mp4', ambientSound: 'ambient.mp3' };

const scene = new THREE.Scene(); scene.background = new THREE.Color(0x000000); scene.fog = new THREE.FogExp2(0x000000, 0.035);
const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 300); camera.position.y = 1.5;
const renderer = new THREE.WebGLRenderer({ antialias: true }); renderer.setSize(window.innerWidth, window.innerHeight); renderer.shadowMap.enabled = true; document.body.appendChild(renderer.domElement);
const controls = new THREE.PointerLockControls(camera, document.body);
const blocker = document.getElementById('blocker'); const instructions = document.getElementById('instructions');
const audioListener = new THREE.AudioListener(); camera.add(audioListener);
const audioLoader = new THREE.AudioLoader(); 
const ambientAudio = new THREE.Audio(audioListener);
const nextbotAudio = new THREE.PositionalAudio(audioListener); 
const agroAudio = new THREE.Audio(audioListener); 
let isAmbientLoaded = false; let isBotAudioLoaded = false;

audioLoader.load(assets.ambientSound, function(buffer) { ambientAudio.setBuffer(buffer); ambientAudio.setLoop(true); ambientAudio.setVolume(0.15); isAmbientLoaded = true; }, undefined, function() { alert("Brak pliku " + assets.ambientSound); });
audioLoader.load(assets.nextbotSound, function(buffer) { nextbotAudio.setBuffer(buffer); nextbotAudio.setRefDistance(20); nextbotAudio.setLoop(true); nextbotAudio.setVolume(1.0); isBotAudioLoaded = true; }, undefined, function() { alert("Brak pliku " + assets.nextbotSound); }); 
audioLoader.load(assets.agroSound, function(buffer) { agroAudio.setBuffer(buffer); agroAudio.setLoop(true); });

// BEACONS & 3 BUTTONS
function createButton(id) { 
    const group = new THREE.Group(); 
    const base = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.1, 0.8), new THREE.MeshStandardMaterial({color: 0x333333})); group.add(base); 
    const btn = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.2, 0.5), new THREE.MeshStandardMaterial({color: 0xff0000, emissive: 0x550000})); btn.position.y = 0.15; group.add(btn); 
    const light = new THREE.PointLight(0xff0000, 1, 3); light.position.y = 0.5; group.add(light); 
    // LASER
    const beam = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 300, 8), new THREE.MeshBasicMaterial({ color: 0xff0000, opacity: 0.8, transparent: true })); beam.position.y = 150; group.add(beam);
    let x = (Math.random()-0.5)*1000; let z = (Math.random()-0.5)*1000; group.position.set(x, getTerrainHeight(x,z) + 0.05, z); group.name = "button" + id; scene.add(group); interactables.push(group); 
} 
for(let i=1; i<=3; i++) createButton(i);
<script>
// --- DETEKCJA MOBILNA I OPTYMALIZACJA ---
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

if(isMobile) { 
    document.getElementById('mobileControls').style.display = 'block'; 
    document.getElementById('pcControls').innerText = "Sterowanie dotykowe aktywne"; 
}

// OPTYMALIZACJA: Na PC 13000 drzew, na telefonie tylko 2500 dla p≈Çynno≈õci
const TREE_COUNT = isMobile ? 2500 : 13000; 
const BUSH_COUNT = isMobile ? 1500 : 6000;

function stopAllGameSounds() { if(ambientAudio && ambientAudio.isPlaying) ambientAudio.stop(); if(nextbotAudio && nextbotAudio.isPlaying) nextbotAudio.stop(); if(agroAudio && agroAudio.isPlaying) agroAudio.stop(); let c = document.getElementById('sndCrickets'); c.pause(); c.currentTime=0; let f = document.getElementById('sndFakeJumpscare'); f.pause(); f.currentTime=0; }

let introFinished = false; let calibInterval; let calibTimeout1; let calibTimeout2;
setTimeout(() => { const btn = document.getElementById('acceptWarningBtn'); btn.style.pointerEvents = "auto"; btn.style.opacity = "1"; }, 3000);
document.getElementById('acceptWarningBtn').addEventListener('click', function() { document.getElementById('introWarning').style.display = 'none'; startCalibration(); });

function skipIntro() { if(introFinished) return; clearInterval(calibInterval); clearTimeout(calibTimeout1); clearTimeout(calibTimeout2); stopAllGameSounds(); document.getElementById('introWarning').style.display = 'none'; document.getElementById('calibrationScreen').style.display = 'none'; document.getElementById('firstJumpscare').style.display = 'none'; document.getElementById('blocker').style.display = 'flex'; introFinished = true; animate(); }
window.addEventListener('keydown', function(e) { if (e.code === 'Enter' && !introFinished) skipIntro(); });
document.getElementById('calibrationScreen').addEventListener('touchstart', skipIntro);

function startCalibration() { document.getElementById('calibrationScreen').style.display = 'flex'; let c = document.getElementById('sndCrickets'); c.volume = 0.1; c.play().catch(e=>console.warn(e)); let p = 0; calibInterval = setInterval(() => { p += Math.floor(Math.random() * 5); if(p>99) p=99; document.getElementById('calibTimer').innerText = p; }, 700); calibTimeout1 = setTimeout(() => { clearInterval(calibInterval); c.pause(); c.currentTime = 0; document.getElementById('calibrationScreen').style.display = 'none'; document.getElementById('firstJumpscare').style.display = 'block'; let l = document.getElementById('sndFakeJumpscare'); l.volume = 1.0; l.play().catch(e=>console.warn(e)); calibTimeout2 = setTimeout(() => { l.pause(); l.currentTime = 0; document.getElementById('firstJumpscare').style.display = 'none'; document.getElementById('blocker').style.display = 'flex'; introFinished = true; animate(); }, 2500); }, 15000); }

let isSecretMode = false; let gameWon = false; let hasFlashlight = false; let flashlightSpot; let buttonsFound = 0; let coinsCollected = 0; let isAggro = false; let nextbotTrackerActive = false; let gameStarted = false; let speedTimeLeft = 0; let trackerTimeLeft = 0; let speedMult = 1.0; let bushCooldownTime = 0; let isHiding = false; let isSprinting = false; let velocityY = 0; const gravity = -30.0; const jumpStrength = 12.0; let canJump = false; 
const gridCellSize = 20; const treeCollisionGrid = {}; function getGridKey(x, z) { return Math.floor(x / gridCellSize) + "_" + Math.floor(z / gridCellSize); }
let assets = { nextbotImg: 'nextbot.jpg', nextbotSound: 'nextbotsound.mp3', agroSound: 'agro.mp3', puzzle1Sound: 'zagadka1.mp3', puzzle2Video: 'wideo.mp4', ambientSound: 'ambient.mp3' };

const scene = new THREE.Scene(); scene.background = new THREE.Color(0x000000); scene.fog = new THREE.FogExp2(0x000000, 0.035);
const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 300); camera.position.y = 1.5;
const renderer = new THREE.WebGLRenderer({ antialias: !isMobile }); // Antialiasing OFF na mobile dla FPS
renderer.setSize(window.innerWidth, window.innerHeight); 
// OPTYMALIZACJA PIKSELI NA MOBILE
renderer.setPixelRatio(isMobile ? 1 : window.devicePixelRatio);
renderer.shadowMap.enabled = !isMobile; // Cienie OFF na mobile
document.body.appendChild(renderer.domElement);

const controls = new THREE.PointerLockControls(camera, document.body);
const blocker = document.getElementById('blocker'); const instructions = document.getElementById('instructions');
const audioListener = new THREE.AudioListener(); camera.add(audioListener);
const audioLoader = new THREE.AudioLoader(); 
const ambientAudio = new THREE.Audio(audioListener);
const nextbotAudio = new THREE.PositionalAudio(audioListener); 
const agroAudio = new THREE.Audio(audioListener); 
let isAmbientLoaded = false; let isBotAudioLoaded = false;

audioLoader.load(assets.ambientSound, function(buffer) { ambientAudio.setBuffer(buffer); ambientAudio.setLoop(true); ambientAudio.setVolume(0.15); isAmbientLoaded = true; }, undefined, function() { alert("Brak pliku " + assets.ambientSound); });
audioLoader.load(assets.nextbotSound, function(buffer) { nextbotAudio.setBuffer(buffer); nextbotAudio.setRefDistance(20); nextbotAudio.setLoop(true); nextbotAudio.setVolume(1.0); isBotAudioLoaded = true; }, undefined, function() { alert("Brak pliku " + assets.nextbotSound); }); 
audioLoader.load(assets.agroSound, function(buffer) { agroAudio.setBuffer(buffer); agroAudio.setLoop(true); });

// BEACONS & 3 BUTTONS (ZMNIEJSZONE DO 3 DLA BALANSU)
function createButton(id) { 
    const group = new THREE.Group(); 
    const base = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.1, 0.8), new THREE.MeshStandardMaterial({color: 0x333333})); group.add(base); 
    const btn = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.2, 0.5), new THREE.MeshStandardMaterial({color: 0xff0000, emissive: 0x550000})); btn.position.y = 0.15; group.add(btn); 
    const light = new THREE.PointLight(0xff0000, 1, 3); light.position.y = 0.5; group.add(light); 
    // GIGANTYCZNY CZERWONY LASER (BEACON)
    const beam = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 400, 8), new THREE.MeshBasicMaterial({ color: 0xff0000, opacity: 0.6, transparent: true })); beam.position.y = 200; group.add(beam);
    let x = (Math.random()-0.5)*1000; let z = (Math.random()-0.5)*1000; group.position.set(x, getTerrainHeight(x,z) + 0.05, z); group.name = "button" + id; scene.add(group); interactables.push(group); 
} 
for(let i=1; i<=3; i++) createButton(i);

let extraNextbots = []; 
function checkSecret() { 
    const code = document.getElementById('secretCode').value; 
    if (code === "...") { isAggro = true; alert("CHAOS MODE: 10 BOTS!"); for(let i=0; i<9; i++) { let c = nextbot.clone(); c.position.set((Math.random()-0.5)*1000, 0, (Math.random()-0.5)*1000); scene.add(c); extraNextbots.push(c); } }
    else if(code === "81ZJA") { isSecretMode = true; if(nextbotAudio.isPlaying) nextbotAudio.stop(); if(agroAudio.isPlaying) agroAudio.stop(); assets.nextbotImg = 'nextbot2.png'; assets.nextbotSound = 'nextbotsound2.mp3'; assets.agroSound = 'agro2.mp3'; textureLoader.load(assets.nextbotImg, function(t) { nextbotMat.map = t; let ar = t.image.width / t.image.height; nextbot.scale.set(6 * ar, 6, 1); extraNextbots.forEach(c => { c.material = nextbotMat; c.scale.set(6 * ar, 6, 1); }); }); audioLoader.load(assets.nextbotSound, function(b) { nextbotAudio.setBuffer(b); nextbotAudio.setRefDistance(25); if(gameStarted) nextbotAudio.play(); }); audioLoader.load(assets.agroSound, function(b) { agroAudio.setBuffer(b); }); alert("SECRET MODE ACTIVATED"); } 
}

function startGameLogic() { if(!introFinished) return; if (audioListener.context.state === 'suspended') audioListener.context.resume(); if (isAmbientLoaded && !ambientAudio.isPlaying) ambientAudio.play(); if (isBotAudioLoaded && !nextbotAudio.isPlaying) nextbotAudio.play(); }
document.addEventListener('click', startGameLogic); document.addEventListener('touchstart', startGameLogic);
instructions.addEventListener('click', function () { if(introFinished && !isHiding) controls.lock(); });
blocker.addEventListener('touchstart', function() { if(introFinished && !isHiding) { blocker.style.display = 'none'; gameStarted = true; } });
controls.addEventListener('lock', function () { blocker.style.display = 'none'; if(isSecretMode && !gameWon) showWarningText(); gameStarted = true; });
controls.addEventListener('unlock', function () { if(!gameWon && introFinished && !isHiding && document.getElementById('puzzle1').style.display !== 'block') { blocker.style.display = 'flex'; } });

function createTextSprite(msg) { const c = document.createElement('canvas'); const ctx = c.getContext('2d'); c.width = 512; c.height = 128; ctx.font = "Bold 60px Courier"; ctx.fillStyle = "white"; ctx.textAlign = "center"; ctx.fillText(msg, 256, 64); const t = new THREE.CanvasTexture(c); const s = new THREE.Sprite(new THREE.SpriteMaterial({ map: t })); s.scale.set(3, 0.75, 1); return s; }
function getTerrainHeight(x, z) { return Math.sin(x / 10) * Math.cos(z / 10) * 2; }

const textureLoader = new THREE.TextureLoader(); const floorTexture = textureLoader.load('https://threejs.org/examples/textures/terrain/grasslight-big.jpg'); floorTexture.wrapS = floorTexture.wrapT = THREE.RepeatWrapping; floorTexture.repeat.set(100, 100);
const terrain = new THREE.Mesh(new THREE.PlaneGeometry(1200, 1200, 200, 200), new THREE.MeshStandardMaterial({ map: floorTexture, roughness: 0.9, color: 0x333333 }));
const posAttr = terrain.geometry.attributes.position; for(let i=0; i<posAttr.count; i++) posAttr.setZ(i, getTerrainHeight(posAttr.getX(i), posAttr.getY(i)));
terrain.geometry.computeVertexNormals(); terrain.rotation.x = -Math.PI / 2; scene.add(terrain);

const ambientLight = new THREE.AmbientLight(0x010101); scene.add(ambientLight);
flashlightSpot = new THREE.SpotLight(0xffffff, 0, 40, Math.PI/5, 0.3, 1); flashlightSpot.position.set(0, 0, 0); flashlightSpot.target.position.set(0, 0, -1); camera.add(flashlightSpot); camera.add(flashlightSpot.target); scene.add(camera);

const interactables = [];
const door = new THREE.Mesh(new THREE.BoxGeometry(2, 4, 0.2), new THREE.MeshStandardMaterial({color: 0xcccccc})); door.position.set(300, getTerrainHeight(300, 300) + 2, 300); door.visible = false; door.name = "door"; scene.add(door); interactables.push(door);

// VEGETATION ZOPTYMALIZOWANA
const treeTrunkGeo = new THREE.CylinderGeometry(0.4, 0.6, 6, 8); const treeMat = new THREE.MeshStandardMaterial({color: 0x1a0f00}); const leavesGeo = new THREE.ConeGeometry(2.5, 6, 8); const leavesMat = new THREE.MeshStandardMaterial({color: 0x001a00});
// U≈ªYCIE ZMIENNEJ TREE_COUNT (2500 mobile / 13000 PC)
const iTrunk = new THREE.InstancedMesh(treeTrunkGeo, treeMat, TREE_COUNT); const iLeaf = new THREE.InstancedMesh(leavesGeo, leavesMat, TREE_COUNT);
const dummy = new THREE.Object3D();
for(let i=0; i<TREE_COUNT; i++) { let x=(Math.random()-0.5)*1100; let z=(Math.random()-0.5)*1100; let y=getTerrainHeight(x,z); let k=getGridKey(x,z); if(!treeCollisionGrid[k]) treeCollisionGrid[k]=[]; treeCollisionGrid[k].push({x:x,z:z,radius:0.6}); dummy.position.set(x,y+2.5,z); dummy.rotation.y=Math.random()*3; dummy.updateMatrix(); iTrunk.setMatrixAt(i,dummy.matrix); dummy.position.set(x,y+7,z); dummy.updateMatrix(); iLeaf.setMatrixAt(i,dummy.matrix); }
scene.add(iTrunk); scene.add(iLeaf);

// KRZAKI ZOPTYMALIZOWANE
const bushGeo = new THREE.IcosahedronGeometry(1, 0); const bushMat = new THREE.MeshStandardMaterial({color: 0x002200});
const iBush = new THREE.InstancedMesh(bushGeo, bushMat, BUSH_COUNT);
for(let i=0; i<BUSH_COUNT; i++) { let x=(Math.random()-0.5)*1100; let z=(Math.random()-0.5)*1100; let y=getTerrainHeight(x,z); dummy.position.set(x,y,z); dummy.scale.setScalar(0.5+Math.random()*0.5); dummy.updateMatrix(); iBush.setMatrixAt(i,dummy.matrix); }
scene.add(iBush);

const hideBushGeo = new THREE.IcosahedronGeometry(2.5, 0); const hideBushMat = new THREE.MeshStandardMaterial({color: 0x003300, emissive: 0x001100}); 
for(let i=0; i<30; i++) { let x=(Math.random()-0.5)*1100; let z=(Math.random()-0.5)*1100; let y=getTerrainHeight(x,z); const g=new THREE.Group(); g.add(new THREE.Mesh(hideBushGeo, hideBushMat)); let l=createTextSprite("Krzak [E]"); l.position.y=3; g.add(l); g.position.set(x,y+1.2,z); g.name="hidingBush"; scene.add(g); interactables.push(g); }

// NEXTBOT
let nextbotMat = new THREE.SpriteMaterial({ color: 0xff0000 }); let nextbot = new THREE.Sprite(nextbotMat); nextbot.renderOrder = 999; nextbot.scale.set(6, 6, 1); nextbot.position.set(250, 0, 250); scene.add(nextbot);
textureLoader.load(assets.nextbotImg, function(t) { nextbotMat.map = t; nextbotMat.color.setHex(0xffffff); let ar = t.image.width / t.image.height; nextbot.scale.set(6 * ar, 6, 1); }, undefined, function() { alert("Brak " + assets.nextbotImg); });
nextbot.add(nextbotAudio); 

// CONTROLS
let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false; const velocity = new THREE.Vector3(); 
const joystickZone = document.getElementById('joystickZone'); const joystickKnob = document.getElementById('joystickKnob'); let joystickActive = false; let joystickCenter = { x: 0, y: 0 };
joystickZone.addEventListener('touchstart', (e) => { e.preventDefault(); joystickActive = true; const r = joystickZone.getBoundingClientRect(); joystickCenter = { x: r.left + r.width/2, y: r.top + r.height/2 }; handleJoystick(e.touches[0]); });
joystickZone.addEventListener('touchmove', (e) => { e.preventDefault(); if(joystickActive) handleJoystick(e.touches[0]); });
joystickZone.addEventListener('touchend', (e) => { e.preventDefault(); joystickActive = false; joystickKnob.style.top = '50%'; joystickKnob.style.left = '50%'; moveForward = moveBackward = moveLeft = moveRight = false; });
function handleJoystick(t) { const dx = t.clientX - joystickCenter.x; const dy = t.clientY - joystickCenter.y; const d = Math.min(Math.sqrt(dx*dx + dy*dy), 75); const a = Math.atan2(dy, dx); joystickKnob.style.left = (50 + (Math.cos(a) * d / 75) * 50) + '%'; joystickKnob.style.top = (50 + (Math.sin(a) * d / 75) * 50) + '%'; moveForward = dy < -20; moveBackward = dy > 20; moveLeft = dx < -20; moveRight = dx > 20; }
document.getElementById('btnJump').addEventListener('touchstart', (e) => { e.preventDefault(); if(canJump) { velocityY = jumpStrength; canJump = false; } });
document.getElementById('btnInteract').addEventListener('touchstart', (e) => { e.preventDefault(); interact(); });
document.getElementById('btnSprint').addEventListener('touchstart', (e) => { e.preventDefault(); isSprinting = true; });
document.getElementById('btnSprint').addEventListener('touchend', (e) => { e.preventDefault(); isSprinting = false; });
const lookZone = document.getElementById('lookZone'); let lastTouchX = 0; let lastTouchY = 0;
lookZone.addEventListener('touchstart', (e) => { lastTouchX = e.touches[0].clientX; lastTouchY = e.touches[0].clientY; });
lookZone.addEventListener('touchmove', (e) => { if(!gameStarted || isHiding) return; const t = e.touches[0]; const dx = t.clientX - lastTouchX; const dy = t.clientY - lastTouchY; camera.rotation.y -= dx * 0.005; camera.rotation.x -= dy * 0.005; lastTouchX = t.clientX; lastTouchY = t.clientY; });

const onKeyDown = function (e) { if(!introFinished) return; switch (e.code) { case 'KeyW': moveForward = true; break; case 'KeyS': moveBackward = true; break; case 'KeyA': moveLeft = true; break; case 'KeyD': moveRight = true; break; case 'KeyE': interact(); break; case 'ShiftLeft': isSprinting = true; break; case 'Space': if(canJump) { velocityY = jumpStrength; canJump = false; } break; } };
const onKeyUp = function (e) { switch (e.code) { case 'KeyW': moveForward = false; break; case 'KeyS': moveBackward = false; break; case 'KeyA': moveLeft = false; break; case 'KeyD': moveRight = false; break; case 'ShiftLeft': isSprinting = false; break; } };
document.addEventListener('keydown', onKeyDown); document.addEventListener('keyup', onKeyUp);

function interact() {
    raycaster.setFromCamera(new THREE.Vector2(0,0), camera); const intersects = raycaster.intersectObjects(interactables, true);
    if(intersects.length > 0 && intersects[0].distance < 4) {
        let obj = intersects[0].object; while(obj.parent && obj.parent.type !== 'Scene') obj = obj.parent;
        if(obj.name.includes("button")) { if(!isMobile) controls.unlock(); if(obj) scene.remove(obj); buttonsFound++; document.getElementById('btnCount').innerText = buttonsFound; if(buttonsFound >= 3) door.visible = true; document.getElementById('puzzle1').style.display = 'block'; }
        else if(obj.name === "door" && buttonsFound >= 3) winGame();
    }
}

function winGame() { gameWon = true; if(!isMobile) controls.unlock(); stopAllGameSounds(); document.getElementById('endScreen').style.display = 'block'; }
function triggerRealJumpscare() { gameWon = false; if(!isMobile) controls.unlock(); stopAllGameSounds(); document.getElementById('gameJumpscare').style.display = 'block'; document.getElementById('sndRealJumpscare').play(); setTimeout(() => { document.getElementById('gameJumpscare').style.display = 'none'; document.getElementById('endScreen').style.display = 'block'; }, 2000); }

let prevTime = performance.now();
function animate() {
    requestAnimationFrame(animate); const time = performance.now(); const delta = (time - prevTime) / 1000;
    if (controls.isLocked === true && !isHiding) {
        velocity.x -= velocity.x * 10.0 * delta; velocity.z -= velocity.z * 10.0 * delta;
        direction.z = Number(moveForward) - Number(moveBackward); direction.x = Number(moveRight) - Number(moveLeft); direction.normalize();
        let s = (isSprinting ? 55.0 : 35.0) * speedMult; if (moveForward || moveBackward) velocity.z -= direction.z * s * delta; if (moveLeft || moveRight) velocity.x -= direction.x * s * delta;
        controls.moveRight(-velocity.x * delta); controls.moveForward(-velocity.z * delta);
        velocityY += gravity * delta; camera.position.y += velocityY * delta;
    } else if (isMobile && gameStarted && !isHiding) {
        let s = (isSprinting ? 55.0 : 35.0) * speedMult * delta; let mf = 0; let mr = 0;
        if (moveForward) mf = s; if (moveBackward) mf = -s; if (moveLeft) mr = -s; if (moveRight) mr = s;
        const f = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion); f.y=0; f.normalize();
        const r = new THREE.Vector3(1, 0, 0).applyQuaternion(camera.quaternion); r.y=0; r.normalize();
        camera.position.addScaledVector(f, mf); camera.position.addScaledVector(r, mr);
        velocityY += gravity * delta; camera.position.y += velocityY * delta;
    }
    if((controls.isLocked || (isMobile && gameStarted)) && !isHiding) {
        let gh = getTerrainHeight(camera.position.x, camera.position.z); if (camera.position.y < gh + 1.6) { camera.position.y = gh + 1.6; velocityY = 0; canJump = true; }
        // BALANS PRƒòDKO≈öCI BOTA (TUTAJ MO≈ªESZ ZMIENIAƒÜ PRƒòDKO≈öƒÜ)
        let bs = isAggro ? (isSecretMode ? 30 : 10) : (isSecretMode ? 14 : 4.5); 
        const mb = (b) => { let d = new THREE.Vector3().subVectors(camera.position, b.position); d.y=0; d.normalize(); b.position.addScaledVector(d, bs * delta); b.position.y = getTerrainHeight(b.position.x, b.position.z) + 2.2; if(b.position.distanceTo(camera.position) < 2) triggerRealJumpscare(); };
        mb(nextbot); extraNextbots.forEach(c => mb(c));
    }
    prevTime = time; renderer.render(scene, camera);
}
</script>
</body>
</html>
