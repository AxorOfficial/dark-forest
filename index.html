<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Mroczny Las - PC FINAL</title>
    <style>
        body { margin: 0; overflow: hidden; background: black; font-family: 'Courier New', Courier, monospace; color: white; user-select: none; }
        
        /* EKRANY */
        #introWarning { position: absolute; width: 100%; height: 100%; background: black; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        #acceptWarningBtn { padding: 15px 30px; font-size: 20px; font-weight: bold; background: darkred; color: white; border: 2px solid red; cursor: pointer; border-radius: 5px; margin-top: 30px; transition: 0.3s; }
        #acceptWarningBtn:hover { background: red; transform: scale(1.1); }

        #calibrationScreen { display: none; position: absolute; width: 100%; height: 100%; background: black; z-index: 900; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        #firstJumpscare { display: none; position: absolute; width: 100%; height: 100%; background: black; z-index: 2000; background-image: url('jumpscarefirst.gif'); background-size: contain; background-repeat: no-repeat; background-position: center; }
        #gameJumpscare { display: none; position: absolute; width: 100%; height: 100%; background: black; z-index: 2000; background-image: url('jumpscare.png'); background-size: contain; background-repeat: no-repeat; background-position: center; }
        
        #blocker { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        #instructions { font-size: 24px; cursor: pointer; text-align: center; padding: 20px; border: 1px solid white; background: rgba(0,0,0,0.5); }
        
        /* UI GRY */
        #ui { position: absolute; top: 10px; left: 10px; z-index: 50; font-size: 20px; text-shadow: 2px 2px 2px black; pointer-events: none; }
        .ui-item { margin-bottom: 5px; }
        #buffsContainer { margin-top: 15px; font-weight: bold; }
        .buff-speed { color: yellow; display: none; }
        .buff-tracker { color: red; display: none; }
        .debuff-bush { color: purple; display: none; } 

        #crosshair { position: absolute; top: 50%; left: 50%; width: 6px; height: 6px; background: white; border-radius: 50%; transform: translate(-50%, -50%); z-index: 50; pointer-events: none; box-shadow: 0 0 5px white; }
        
        /* INTERAKCJE I MINIGRY */
        .overlay { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(15, 15, 15, 0.98); padding: 30px; border: 2px solid white; z-index: 200; text-align: center; border-radius: 5px; min-width: 300px; }
        input[type="text"] { background: #222; color: white; border: 1px solid white; padding: 10px; font-size: 16px; width: 80%; cursor: text; margin-top: 10px; }
        button { background: white; color: black; border: none; padding: 10px 20px; font-size: 18px; cursor: pointer; margin-top: 15px; transition: 0.2s; }
        button:hover { background: #bbb; }
        #secretInput { margin-top: 20px; font-size: 14px; cursor: default; border-top: 1px solid #444; padding-top: 10px; }
        
        #gdCanvas { border: 2px solid white; background: #222; margin-top: 10px; display: none; cursor: crosshair; }
        #osuCanvas { border: 2px solid white; background: #111; margin-top: 10px; display: block; }
    </style>
</head>
<body>

    <div id="introWarning">
        <h1 style="color: red; text-shadow: 0 0 10px red;">‚ö†Ô∏è OSTRZE≈ªENIE ‚ö†Ô∏è</h1>
        <p>Ta gra zawiera nag≈Çe, g≈Ço≈õne d≈∫wiƒôki.</p>
        <button id="acceptWarningBtn">WEJD≈π W MROK</button>
        <p style="margin-top: 20px; color: gray;">[Wymagane s≈Çuchawki]</p>
    </div>

    <div id="calibrationScreen">
        <h2>Kalibracja D≈∫wiƒôku</h2>
        <p>Ustaw g≈Ço≈õno≈õƒá tak, aby s≈Çyszeƒá ciche cykanie...</p>
        <p style="margin-top: 30px; color: gray;">≈Åadowanie lasu: <span id="calibTimer">0</span>%</p>
    </div>

    <div id="firstJumpscare"></div>
    <div id="gameJumpscare"></div>

    <div id="ui">
        <div class="ui-item">üí∞ Monety: <span id="coinCount">0</span>/250</div>
        <div class="ui-item">üß© Przyciski: <span id="btnCount">0</span>/3</div>
        <div id="buffsContainer">
            <div id="uiSpeed" class="buff-speed">‚ö° Szybko≈õƒá: <span id="speedTimeText">60</span>s</div>
            <div id="uiTracker" class="buff-tracker">üëÅÔ∏è Radar: <span id="trackerTimeText">10</span>s</div>
            <div id="uiBushCD" class="debuff-bush">üö´ Krzaki: <span id="bushTimeText">180</span>s</div>
        </div>
    </div>

    <div id="crosshair"></div>

    <div id="blocker">
        <div id="instructions">
            <h1 id="mainTitle">Mroczny Las</h1>
            <p>- Kliknij, aby graƒá -</p>
            <p style="font-size: 14px; color: #aaa;">WSAD - Ruch | SHIFT - Sprint | E - Interakcja</p>
            <div id="secretInput">
                <p>Tajny Kod:</p>
                <input type="text" id="secretCodeInput" placeholder="???" maxlength="5">
                <button onclick="checkSecret()">Zastosuj</button>
            </div>
        </div>
    </div>

    <div id="puzzle1" class="overlay"><h2>Zagadka #1</h2><p>Masz 20 sekund!</p><input type="text" id="ans1" placeholder="Odpowied≈∫..."><button onclick="solvePuzzle1()">Zatwierd≈∫</button><p id="timer1" style="color: red;">20</p></div>
    <div id="puzzle2" class="overlay"><h2>Zagadka #2</h2><p>Co to za poziom?</p><video id="puzzleVideo" width="300" height="200" controls></video><input type="text" id="ans2" placeholder="Odpowied≈∫..."><button onclick="solvePuzzle2()">Zatwierd≈∫</button><p id="timer2" style="color: red;">20</p></div>
    <div id="puzzle3" class="overlay"><h2>Zagadka #3 - Wave</h2><p>Trzymaj myszkƒô, by lecieƒá w g√≥rƒô!</p><canvas id="gdCanvas" width="400" height="300"></canvas><button id="startGdBtn" onclick="startGD()">Start</button><p id="timer3" style="color: red;"></p></div>
    
    <div id="osuOverlay" class="overlay">
        <h2 style="color: lime;">ü§´ Cicho!</h2>
        <p>Trafiaj w nuty w rytm, ≈ºeby nie ha≈Çasowaƒá.</p>
        <p>Klawisze: <b>D F J K</b></p>
        <p>Celno≈õƒá: <span id="osuAcc">100</span>% (Wymagane 85%)</p>
        <canvas id="osuCanvas" width="400" height="500"></canvas>
    </div>

    <div id="shop" class="overlay">
        <h2>Wƒôdrowiec</h2>
        <p>Monety: <span id="shopCoins"></span></p>
        <p id="shopWarning" style="color: red; display: none;">Brak monet!</p>
        <button onclick="buySpeed()">Mikstura Szybko≈õci (1 min) - 10g</button><br>
        <button onclick="buyTracker()">Lokalizator Nextbota (10s) - 10g</button><br>
        <button onclick="closeShop()">Wyjd≈∫</button>
    </div>

    <div id="endScreen" class="overlay">
        <h1 id="endTitle" style="color: gold; font-size: 40px;">UCIEK≈ÅE≈ö!</h1>
        <p id="endSubtitle">Uda≈Ço Ci siƒô opu≈õciƒá las.</p>
        <button onclick="location.reload()">Zagraj Ponownie</button>
    </div>

    <audio id="sndCrickets" src="crickets.mp3" loop preload="auto"></audio>
    <audio id="sndFakeJumpscare" src="jumpscarefirstsound.mp3" preload="auto"></audio>
    <audio id="sndRealJumpscare" src="jumpscaresound.mp3" preload="auto"></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/PointerLockControls.js"></script>

<script>
// --- KONFIGURACJA ROZGRYWKI ---
const TREES_COUNT = 13000; // Du≈ºo drzew (PC)
const MAP_SIZE = 1200;

// Generowanie losowego kodu sekretnego na tƒô sesjƒô
const SESSION_SECRET_CODE = Math.random().toString(36).substring(2, 7).toUpperCase();
console.log("Secret Code (Debug):", SESSION_SECRET_CODE); // Dla Ciebie do test√≥w w konsoli F12

// Zmienne stanu
let gameStarted = false; let introFinished = false; 
let isSecretMode = false; let gameWon = false; 
let hasFlashlight = false; let flashlightSpot;
let buttonsFound = 0; let coinsCollected = 0; 
let isAggro = false; let nextbotTrackerActive = false;
let speedTimeLeft = 0; let trackerTimeLeft = 0; let speedMult = 1.0; 
let bushCooldownTime = 0; let isHiding = false; 
let isSprinting = false; let velocityY = 0; const gravity = -30.0; const jumpStrength = 12.0; let canJump = false; 

// Assets
let assets = { nextbotImg: 'nextbot.jpg', nextbotSound: 'nextbotsound.mp3', agroSound: 'agro.mp3', puzzle1Sound: 'zagadka1.mp3', puzzle2Video: 'wideo.mp4', ambientSound: 'ambient.mp3' };

// --- INIT SILNIKA ---
function stopAllGameSounds() {
    if(ambientAudio && ambientAudio.isPlaying) ambientAudio.stop();
    if(nextbotAudio && nextbotAudio.isPlaying) nextbotAudio.stop();
    if(agroAudio && agroAudio.isPlaying) agroAudio.stop();
    document.getElementById('sndCrickets').pause();
    document.getElementById('sndFakeJumpscare').pause();
}

// Kalibracja
let calibInterval, calibTimeout1, calibTimeout2;
document.getElementById('acceptWarningBtn').addEventListener('click', () => {
    document.getElementById('introWarning').style.display = 'none';
    startCalibration();
});

function startCalibration() {
    document.getElementById('calibrationScreen').style.display = 'flex';
    let c = document.getElementById('sndCrickets'); c.volume = 0.1; c.play().catch(e=>{});
    let p = 0; 
    calibInterval = setInterval(() => { p += Math.floor(Math.random()*5); if(p>99)p=99; document.getElementById('calibTimer').innerText = p; }, 700);
    calibTimeout1 = setTimeout(() => {
        clearInterval(calibInterval); c.pause(); c.currentTime=0;
        document.getElementById('calibrationScreen').style.display = 'none';
        document.getElementById('firstJumpscare').style.display = 'block';
        let f = document.getElementById('sndFakeJumpscare'); f.volume=1.0; f.play().catch(e=>{});
        calibTimeout2 = setTimeout(() => {
            f.pause(); f.currentTime=0;
            document.getElementById('firstJumpscare').style.display = 'none';
            document.getElementById('blocker').style.display = 'flex';
            introFinished = true; animate();
        }, 2500);
    }, 15000);
}

// SCENA 3D
const scene = new THREE.Scene(); scene.background = new THREE.Color(0x020202); scene.fog = new THREE.FogExp2(0x020202, 0.035);
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 400); camera.position.y = 1.6;
const renderer = new THREE.WebGLRenderer({ antialias: true }); renderer.setSize(window.innerWidth, window.innerHeight); renderer.shadowMap.enabled = true; document.body.appendChild(renderer.domElement);
const controls = new THREE.PointerLockControls(camera, document.body);
const audioListener = new THREE.AudioListener(); camera.add(audioListener);
const audioLoader = new THREE.AudioLoader();
const ambientAudio = new THREE.Audio(audioListener);
const nextbotAudio = new THREE.PositionalAudio(audioListener);
const agroAudio = new THREE.Audio(audioListener);

// ≈Åadowanie Audio z pewno≈õciƒÖ zapƒôtlenia
let isAudioReady = false;
audioLoader.load(assets.ambientSound, (b)=>{ ambientAudio.setBuffer(b); ambientAudio.setLoop(true); ambientAudio.setVolume(0.15); isAudioReady=true; });
audioLoader.load(assets.nextbotSound, (b)=>{ nextbotAudio.setBuffer(b); nextbotAudio.setRefDistance(20); nextbotAudio.setLoop(true); nextbotAudio.setVolume(1.5); }); // G≈Ço≈õniejszy bot
audioLoader.load(assets.agroSound, (b)=>{ agroAudio.setBuffer(b); agroAudio.setLoop(true); });

// KLIKNIƒòCIE W GRƒò (START)
const blocker = document.getElementById('blocker');
const instructions = document.getElementById('instructions');
instructions.addEventListener('click', ()=>{
    if(introFinished && !isHiding) {
        controls.lock();
        if(audioListener.context.state === 'suspended') audioListener.context.resume();
        if(isAudioReady && !ambientAudio.isPlaying) ambientAudio.play();
        if(!nextbotAudio.isPlaying && gameStarted) nextbotAudio.play(); // Start d≈∫wiƒôku bota dopiero jak gra ruszy
    }
});
controls.addEventListener('lock', ()=>{ blocker.style.display='none'; gameStarted=true; if(!nextbotAudio.isPlaying) nextbotAudio.play(); });
controls.addEventListener('unlock', ()=>{ if(!gameWon && introFinished && !isHiding && document.getElementById('puzzle1').style.display !== 'block' && document.getElementById('shop').style.display !== 'block') blocker.style.display='flex'; });

// SWIAT≈ÅO I TEREN
const ambientLight = new THREE.AmbientLight(0x080808); scene.add(ambientLight); // Bardzo ciemno
flashlightSpot = new THREE.SpotLight(0xffffff, 0, 50, Math.PI/5, 0.3, 1); camera.add(flashlightSpot); camera.add(flashlightSpot.target); flashlightSpot.target.position.set(0,0,-1); scene.add(camera);

function getTerrainHeight(x, z) { return Math.sin(x/12)*Math.cos(z/12)*2.5; }
const texLoader = new THREE.TextureLoader();
const floorTex = texLoader.load('https://threejs.org/examples/textures/terrain/grasslight-big.jpg'); floorTex.wrapS=floorTex.wrapT=THREE.RepeatWrapping; floorTex.repeat.set(100,100);
const terrainGeo = new THREE.PlaneGeometry(MAP_SIZE, MAP_SIZE, 256, 256);
const pos = terrainGeo.attributes.position; for(let i=0;i<pos.count;i++) pos.setZ(i, getTerrainHeight(pos.getX(i), pos.getY(i)));
terrainGeo.computeVertexNormals();
const terrain = new THREE.Mesh(terrainGeo, new THREE.MeshStandardMaterial({map:floorTex, roughness:0.9, color:0x333333}));
terrain.rotation.x = -Math.PI/2; scene.add(terrain);

function createTextSprite(msg) { const c=document.createElement('canvas'); const x=c.getContext('2d'); c.width=512; c.height=128; x.font="Bold 60px Courier New"; x.fillStyle="white"; x.textAlign="center"; x.fillText(msg,256,64); const t=new THREE.CanvasTexture(c); const s=new THREE.Sprite(new THREE.SpriteMaterial({map:t})); s.scale.set(3,0.75,1); return s; }

// --- OBIEKTY ---
const interactables = [];
const treeCollisionGrid = {}; function getGridKey(x, z) { return Math.floor(x/20)+"_"+Math.floor(z/20); }

// RO≈öLINNO≈öƒÜ
const trunkGeo = new THREE.CylinderGeometry(0.4, 0.6, 6, 8); const trunkMat = new THREE.MeshStandardMaterial({color:0x1a0f00});
const leafGeo = new THREE.ConeGeometry(2.5, 6, 8); const leafMat = new THREE.MeshStandardMaterial({color:0x001a00});
const iTrunk = new THREE.InstancedMesh(trunkGeo, trunkMat, TREES_COUNT);
const iLeaf = new THREE.InstancedMesh(leafGeo, leafMat, TREES_COUNT);
const dummy = new THREE.Object3D();

for(let i=0; i<TREES_COUNT; i++) {
    let x = (Math.random()-0.5)*1100; let z = (Math.random()-0.5)*1100;
    // Oczyszczenie spawnu
    if(Math.abs(x)<20 && Math.abs(z)<20) x+=50; 
    let y = getTerrainHeight(x,z);
    
    let key = getGridKey(x,z); if(!treeCollisionGrid[key]) treeCollisionGrid[key]=[]; treeCollisionGrid[key].push({x:x,z:z,r:0.6});
    
    dummy.position.set(x,y+2.5,z); dummy.rotation.y=Math.random()*3; dummy.updateMatrix(); iTrunk.setMatrixAt(i,dummy.matrix);
    dummy.position.set(x,y+7,z); dummy.updateMatrix(); iLeaf.setMatrixAt(i,dummy.matrix);
}
scene.add(iTrunk); scene.add(iLeaf);

// KRZAKI (6000)
const bushGeo = new THREE.IcosahedronGeometry(1,0); const bushMat = new THREE.MeshStandardMaterial({color:0x002200});
const iBush = new THREE.InstancedMesh(bushGeo, bushMat, 6000);
for(let i=0; i<6000; i++) { let x=(Math.random()-0.5)*1100; let z=(Math.random()-0.5)*1100; let y=getTerrainHeight(x,z); dummy.position.set(x,y,z); dummy.scale.setScalar(0.5+Math.random()); dummy.updateMatrix(); iBush.setMatrixAt(i,dummy.matrix); }
scene.add(iBush);

// KRZAKI UKRYCIA (30)
for(let i=0; i<30; i++) {
    let x=(Math.random()-0.5)*1100; let z=(Math.random()-0.5)*1100; let y=getTerrainHeight(x,z);
    const g=new THREE.Group(); 
    g.add(new THREE.Mesh(new THREE.IcosahedronGeometry(2.5,0), new THREE.MeshStandardMaterial({color:0x003300, emissive:0x001100})));
    let l=createTextSprite("Krzak [E]"); l.position.y=3; g.add(l);
    g.position.set(x,y+1.2,z); g.name="hidingBush"; scene.add(g); interactables.push(g);
}

// 3 PRZYCISKI (ZNERFIONE - LOKALNA CZERWONA PO≈öWIATA, ALE BRAK LASERA)
for(let i=1; i<=3; i++) {
    const g = new THREE.Group();
    const box = new THREE.Mesh(new THREE.BoxGeometry(0.5,0.5,0.5), new THREE.MeshStandardMaterial({color:0xff0000, emissive:0x550000}));
    const glow = new THREE.PointLight(0xff0000, 2, 40); // Zasiƒôg 40 metr√≥w - widaƒá po≈õwiatƒô na drzewach
    g.add(box); g.add(glow);
    let x=(Math.random()-0.5)*1000; let z=(Math.random()-0.5)*1000;
    g.position.set(x, getTerrainHeight(x,z)+0.5, z); g.name="button"+i;
    scene.add(g); interactables.push(g);
}

// SKLEPIKARZE (15 SZTUK + FIOLETOWA POCHODNIA)
const npcGeo = new THREE.ConeGeometry(0.8, 2.5, 8); const npcMat = new THREE.MeshStandardMaterial({color:0x330055});
for(let i=0; i<15; i++) {
    const g = new THREE.Group();
    const body = new THREE.Mesh(npcGeo, npcMat); body.position.y=1.25; g.add(body);
    const head = new THREE.Mesh(new THREE.SphereGeometry(0.5), new THREE.MeshStandardMaterial({color:0x110022})); head.position.y=2.5; g.add(head);
    let l = createTextSprite("Sklep [E]"); l.position.y=3.5; g.add(l);
    
    // FIOLETOWA POCHODNIA
    const torch = new THREE.Mesh(new THREE.CylinderGeometry(0.05,0.05,1.5), new THREE.MeshStandardMaterial({color:0x553311}));
    torch.position.set(1, 0.75, 0); g.add(torch);
    const flame = new THREE.Mesh(new THREE.SphereGeometry(0.2), new THREE.MeshStandardMaterial({color:0xff00ff, emissive:0xff00ff}));
    flame.position.set(1, 1.6, 0); g.add(flame);
    const purpleLight = new THREE.PointLight(0xff00ff, 1.5, 20);
    purpleLight.position.set(1, 1.6, 0); g.add(purpleLight);

    let x=(Math.random()-0.5)*1000; let z=(Math.random()-0.5)*1000;
    g.position.set(x, getTerrainHeight(x,z), z); g.name="npc";
    scene.add(g); interactables.push(g);
}

// MONETY
const coinGeo = new THREE.CylinderGeometry(0.3,0.3,0.1,16); const coinMat = new THREE.MeshStandardMaterial({color:0xffd700, emissive:0xffaa00});
let coinGroups = [];
for(let i=0; i<250; i++) {
    let g = new THREE.Group(); let m = new THREE.Mesh(coinGeo, coinMat); m.rotation.x=Math.PI/2; g.add(m);
    let x=(Math.random()-0.5)*1000; let z=(Math.random()-0.5)*1000;
    g.position.set(x, getTerrainHeight(x,z)+1, z); g.name="coin";
    scene.add(g); interactables.push(g); coinGroups.push(g);
}

// LATARKA (ITEM)
const flashG = new THREE.Group(); 
flashG.add(new THREE.Mesh(new THREE.CylinderGeometry(0.05,0.05,0.3), new THREE.MeshStandardMaterial({color:0x222222})));
let flL = createTextSprite("Latarka [E]"); flL.position.y=0.5; flashG.add(flL);
flashG.position.set(5, getTerrainHeight(5,5)+0.5, 5); flashG.name="flashlight"; scene.add(flashG); interactables.push(flashG);

// DRZEWO SEKRETNE (Z KODEM)
const secretTree = new THREE.Group();
const sTrunk = new THREE.Mesh(trunkGeo, trunkMat); sTrunk.position.y=2.5;
const sLeaf = new THREE.Mesh(leafGeo, leafMat); sLeaf.position.y=7;
const sPaper = new THREE.Mesh(new THREE.BoxGeometry(0.6,0.4,0.05), new THREE.MeshStandardMaterial({color:0xffffff})); sPaper.position.set(0, 2.5, 0.45);
secretTree.add(sTrunk); secretTree.add(sLeaf); secretTree.add(sPaper);
let sx=(Math.random()-0.5)*900; let sz=(Math.random()-0.5)*900;
secretTree.position.set(sx, getTerrainHeight(sx,sz), sz); secretTree.name="secretTree";
scene.add(secretTree); interactables.push(secretTree);

// DRZWI WYJ≈öCIA
const door = new THREE.Mesh(new THREE.BoxGeometry(2,4,0.2), new THREE.MeshStandardMaterial({color:0xcccccc}));
door.position.set(100, getTerrainHeight(100,100)+2, 100); door.visible=false; door.name="door"; scene.add(door); interactables.push(door);

// --- NEXTBOT ---
const nextbotMat = new THREE.SpriteMaterial({ color: 0xffffff });
const nextbot = new THREE.Sprite(nextbotMat);
nextbot.scale.set(6, 6, 1);
// Spawn Bota Daleko (Bezpiecze≈Ñstwo)
nextbot.position.set(300, 5, 300);
scene.add(nextbot);
nextbot.add(nextbotAudio);
texLoader.load(assets.nextbotImg, (t)=>{ 
    nextbotMat.map=t; 
    // Fix proporcji
    let ar = t.image.width/t.image.height;
    nextbot.scale.set(6*ar, 6, 1);
});

// --- LOGIKA GRY ---
function checkSecret() {
    const code = document.getElementById('secretCodeInput').value.toUpperCase();
    if(code === SESSION_SECRET_CODE) {
        isSecretMode = true;
        alert("TRYB SEKRETNY AKTYWOWANY: TRUDNO≈öƒÜ EKSTREMALNA");
        // Zmiana asset√≥w
        assets.nextbotImg = 'nextbot2.png'; assets.nextbotSound = 'nextbotsound2.mp3'; assets.agroSound = 'agro2.mp3';
        texLoader.load(assets.nextbotImg, (t)=>{nextbotMat.map=t;});
        audioLoader.load(assets.nextbotSound, (b)=>{nextbotAudio.setBuffer(b); if(gameStarted)nextbotAudio.play();});
        audioLoader.load(assets.agroSound, (b)=>{agroAudio.setBuffer(b);});
    } else {
        alert("Z≈Çy kod.");
    }
}

// STEROWANIE
let moveF=false, moveB=false, moveL=false, moveR=false; const velocity=new THREE.Vector3(); const direction=new THREE.Vector3();
document.addEventListener('keydown', (e)=>{
    if(!introFinished) return;
    if(isHiding) {
        // Obs≈Çuga OSU
        if(e.code==='KeyD') handleOsuInput(0); if(e.code==='KeyF') handleOsuInput(1); if(e.code==='KeyJ') handleOsuInput(2); if(e.code==='KeyK') handleOsuInput(3);
        return;
    }
    switch(e.code){ case 'KeyW': moveF=true; break; case 'KeyS': moveB=true; break; case 'KeyA': moveL=true; break; case 'KeyD': moveR=true; break; case 'ShiftLeft': isSprinting=true; break; case 'Space': if(canJump){velocityY=12; canJump=false;} break; case 'KeyE': interact(); break; }
});
document.addEventListener('keyup', (e)=>{
    if(isHiding) return;
    switch(e.code){ case 'KeyW': moveF=false; break; case 'KeyS': moveB=false; break; case 'KeyA': moveL=false; break; case 'KeyD': moveR=false; break; case 'ShiftLeft': isSprinting=false; break; }
});

const raycaster = new THREE.Raycaster();
function interact() {
    raycaster.setFromCamera(new THREE.Vector2(0,0), camera);
    const intersects = raycaster.intersectObjects(interactables, true);
    if(intersects.length > 0 && intersects[0].distance < 4) {
        let obj = intersects[0].object; while(obj.parent && obj.parent.type!=='Scene') obj = obj.parent;
        
        if(obj.name==="flashlight" && !hasFlashlight) { hasFlashlight=true; flashlightSpot.intensity=2.5; scene.remove(obj); }
        else if(obj.name==="coin") { coinsCollected++; document.getElementById('coinCount').innerText=coinsCollected; scene.remove(obj); }
        else if(obj.name==="npc") { controls.unlock(); document.getElementById('shopCoins').innerText=coinsCollected; document.getElementById('shop').style.display='block'; }
        else if(obj.name==="secretTree") { alert("Na korze wyryto: " + SESSION_SECRET_CODE); }
        else if(obj.name && obj.name.includes("button")) { triggerPuzzle(obj.name.replace("button",""), obj); }
        else if(obj.name==="door" && buttonsFound>=3) { winGame(); }
        else if(obj.name==="hidingBush") { if(bushCooldownTime>0) alert("Zablokowane!"); else startOsuGame(); }
    }
}

// PUZZLE SYSTEM
let currentTimer;
function triggerPuzzle(id, obj) {
    controls.unlock(); if(obj) scene.remove(obj); buttonsFound++; document.getElementById('btnCount').innerText=buttonsFound;
    if(buttonsFound>=3) { door.visible=true; alert("DRZWI OTWARTE!"); }
    if(id==="1") { document.getElementById('puzzle1').style.display='block'; new Audio(assets.puzzle1Sound).play(); startTimer(1,20); }
    else if(id==="2") { document.getElementById('puzzle2').style.display='block'; let v=document.getElementById('puzzleVideo'); v.src=assets.puzzle2Video; v.play(); startTimer(2,20); }
    else if(id==="3") { document.getElementById('puzzle3').style.display='block'; }
}
function startTimer(id, t) { document.getElementById('timer'+id).innerText=t; currentTimer=setInterval(()=>{t--; document.getElementById('timer'+id).innerText=t; if(t<=0){clearInterval(currentTimer); failPuzzle(id);}},1000); }
function solvePuzzle1() { let a=document.getElementById('ans1').value.toLowerCase(); clearInterval(currentTimer); document.getElementById('puzzle1').style.display='none'; controls.lock(); if(a!=="supercalifragilisticexpialidocious") triggerAggro(); }
function solvePuzzle2() { let a=document.getElementById('ans2').value.toLowerCase(); clearInterval(currentTimer); document.getElementById('puzzleVideo').pause(); document.getElementById('puzzle2').style.display='none'; controls.lock(); if(a!=="congregation") triggerAggro(); }
function failPuzzle(id) { document.getElementById('puzzle'+id).style.display='none'; controls.lock(); triggerAggro(); }
function triggerAggro() { isAggro=true; agroAudio.play(); setTimeout(()=>{isAggro=false; agroAudio.stop();},15000); }

// MINIGRY (GD & OSU)
let gdActive=false, gdTime=10, gdY=150, gdHold=false, gdObs=[], gdTrail=[];
function startGD(){ document.getElementById('startGdBtn').style.display='none'; document.getElementById('gdCanvas').style.display='block'; gdActive=true; gdY=150; gdTime=10; gdObs=[]; gdTrail=[]; requestAnimationFrame(gdLoop); const c=document.getElementById('gdCanvas'); c.onmousedown=()=>gdHold=true; c.onmouseup=()=>gdHold=false;}
function gdLoop(){ if(!gdActive)return; gdTime-=0.016; if(gdTime<=0){gdActive=false; document.getElementById('puzzle3').style.display='none'; controls.lock(); return;}
    document.getElementById('timer3').innerText=Math.ceil(gdTime); const ctx=document.getElementById('gdCanvas').getContext('2d'); ctx.clearRect(0,0,400,300);
    gdY+=(gdHold?-5:5); gdTrail.push({x:60,y:gdY}); if(gdTrail.length>20)gdTrail.shift();
    ctx.beginPath(); gdTrail.forEach((p,i)=>{if(i==0)ctx.moveTo(p.x-(20-i)*5,p.y);else ctx.lineTo(p.x-(20-i)*5,p.y);}); ctx.strokeStyle='yellow'; ctx.stroke();
    if(gdY<0||gdY>300){gdActive=false; failPuzzle(3); return;}
    if(Math.random()<0.03) gdObs.push({x:400,y:Math.random()<0.5?0:200,h:100});
    gdObs.forEach((o,i)=>{o.x-=5; ctx.fillStyle='red'; ctx.fillRect(o.x,o.y,30,o.h); if(60>o.x && 60<o.x+30 && gdY>o.y && gdY<o.y+o.h){gdActive=false; failPuzzle(3);} });
    requestAnimationFrame(gdLoop);
}

let osuActive=false, osuTime=15, osuNotes=[], osuHits=0, osuTotal=0;
function startOsuGame() { controls.unlock(); isHiding=true; document.getElementById('osuOverlay').style.display='block'; osuNotes=[]; osuHits=0; osuTotal=0; osuTime=15; osuActive=true; requestAnimationFrame(osuLoop); }
function osuLoop(){ if(!osuActive)return; osuTime-=0.016; if(osuTime<=0) endOsu();
    document.getElementById('osuTimerText').innerText=Math.ceil(osuTime); const ctx=document.getElementById('osuCanvas').getContext('2d'); ctx.clearRect(0,0,400,500);
    ctx.strokeStyle='#444'; for(let i=1;i<4;i++){ctx.beginPath();ctx.moveTo(i*100,0);ctx.lineTo(i*100,500);ctx.stroke();}
    ctx.fillStyle='#004400'; ctx.fillRect(0,400,400,50);
    if(Math.random()<0.04) osuNotes.push({l:Math.floor(Math.random()*4),y:-20,hit:false});
    osuNotes.forEach(n=>{n.y+=5; if(!n.hit){ctx.fillStyle='red'; ctx.fillRect(n.l*100+10,n.y,80,20);} if(n.y>500 && !n.hit){osuTotal++;n.hit=true;updOsu();}});
    requestAnimationFrame(osuLoop);
}
function handleOsuInput(l){ for(let n of osuNotes){if(n.l===l && !n.hit && n.y>380 && n.y<460){n.hit=true; osuHits++; osuTotal++; updOsu(); return;}} }
function updOsu(){ let acc=osuTotal==0?100:Math.round(osuHits/osuTotal*100); document.getElementById('osuAcc').innerText=acc; if(osuTotal>10 && acc<85) endOsu(false); }
function endOsu(success=true){ osuActive=false; document.getElementById('osuOverlay').style.display='none'; isHiding=false; controls.lock(); if(!success){bushCooldownTime=180; triggerAggro(); alert("Za g≈Ço≈õno!");} }

// SKLEP I BUFFY
function closeShop() { document.getElementById('shop').style.display='none'; controls.lock(); }
function buySpeed() { if(coinsCollected>=10){coinsCollected-=10; document.getElementById('coinCount').innerText=coinsCollected; speedTimeLeft=60; closeShop();} else document.getElementById('shopWarning').style.display='block'; }
function buyTracker() { if(coinsCollected>=10){coinsCollected-=10; document.getElementById('coinCount').innerText=coinsCollected; trackerTimeLeft=10; closeShop();} else document.getElementById('shopWarning').style.display='block'; }

function winGame() { gameWon=true; controls.unlock(); stopAllGameSounds(); document.getElementById('endScreen').style.display='block'; if(isSecretMode) document.getElementById('endTitle').innerText="SEKRETNE ZWYCIƒòSTWO"; }
function triggerRealJumpscare() { gameWon=false; controls.unlock(); stopAllGameSounds(); document.getElementById('gameJumpscare').style.display='block'; document.getElementById('sndRealJumpscare').play(); setTimeout(()=>{document.getElementById('gameJumpscare').style.display='none'; document.getElementById('endScreen').innerText="Z≈ÅAPANY!"; document.getElementById('endScreen').style.display='block';}, 2000); }

// --- PƒòTLA GRY ---
let prevTime = performance.now();
let gracePeriod = 5.0; // 5 sekundy spokoju na start

function animate() {
    requestAnimationFrame(animate); const time = performance.now(); const delta = (time - prevTime) / 1000; prevTime = time;
    if(speedTimeLeft>0){speedTimeLeft-=delta; speedMult=2.0; document.getElementById('uiSpeed').style.display='block'; if(speedTimeLeft<=0){speedMult=1.0; document.getElementById('uiSpeed').style.display='none';}}
    if(trackerTimeLeft>0){trackerTimeLeft-=delta; nextbotMat.depthTest=false; document.getElementById('uiTracker').style.display='block'; if(trackerTimeLeft<=0){nextbotMat.depthTest=true; document.getElementById('uiTracker').style.display='none';}}
    if(bushCooldownTime>0){bushCooldownTime-=delta; document.getElementById('uiBushCD').style.display='block'; if(bushCooldownTime<=0) document.getElementById('uiBushCD').style.display='none';}

    if(controls.isLocked && !isHiding) {
        // Ruch Gracza
        velocity.x -= velocity.x * 10.0 * delta; velocity.z -= velocity.z * 10.0 * delta; velocity.y -= 30.0 * delta;
        direction.z = Number(moveF) - Number(moveB); direction.x = Number(moveR) - Number(moveL); direction.normalize();
        let spd = (isSprinting ? 55.0 : 35.0) * speedMult;
        if(moveF || moveB) velocity.z -= direction.z * spd * delta; if(moveL || moveR) velocity.x -= direction.x * spd * delta;
        controls.moveRight(-velocity.x * delta); controls.moveForward(-velocity.z * delta); camera.position.y += velocity.y * delta;
        
        // Kolizja teren
        let gh = getTerrainHeight(camera.position.x, camera.position.z);
        if(camera.position.y < gh + 1.6) { velocity.y=0; camera.position.y=gh+1.6; canJump=true; }

        // Kolizja Drzewa
        let key = getGridKey(camera.position.x, camera.position.z);
        let trees = treeCollisionGrid[key] || [];
        for(let t of trees) {
            let dx=camera.position.x-t.x; let dz=camera.position.z-t.z; let d=Math.sqrt(dx*dx+dz*dz);
            if(d<t.r) { let p=(t.r-d)/d; camera.position.x+=dx*p; camera.position.z+=dz*p; }
        }

        // NEXTBOT AI
        if(gracePeriod > 0) gracePeriod -= delta;
        else {
            let bs = isAggro ? (isSecretMode?30:10) : (isSecretMode?14:4.5);
            let vec = new THREE.Vector3().subVectors(camera.position, nextbot.position); vec.y=0; vec.normalize();
            nextbot.position.addScaledVector(vec, bs*delta);
            nextbot.position.y = getTerrainHeight(nextbot.position.x, nextbot.position.z) + 2.2;
            if(nextbot.position.distanceTo(camera.position) < 2) triggerRealJumpscare();
        }
        
        coinGroups.forEach(c => c.rotation.y += delta*2);
    }
    
    if(isHiding) { nextbot.position.y = getTerrainHeight(nextbot.position.x, nextbot.position.z)+2.2; }
    renderer.render(scene, camera);
}
animate();
</script>
</body>
</html>
