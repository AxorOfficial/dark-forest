<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Mroczny Las - PC FIX</title>
    <style>
        body { margin: 0; overflow: hidden; background: black; font-family: 'Courier New', Courier, monospace; color: white; user-select: none; }
        
        #introWarning { position: absolute; width: 100%; height: 100%; background: black; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        #acceptWarningBtn { padding: 15px 30px; font-size: 20px; font-weight: bold; background: darkred; color: white; border: 2px solid red; cursor: pointer; border-radius: 5px; margin-top: 30px; transition: 0.3s; }
        #acceptWarningBtn:hover { background: red; }

        #ui { position: absolute; top: 10px; left: 10px; z-index: 50; font-size: 20px; text-shadow: 2px 2px 2px black; pointer-events: none; }
        .ui-item { margin-bottom: 5px; }
        
        #crosshair { position: absolute; top: 50%; left: 50%; width: 8px; height: 8px; background: white; border-radius: 50%; transform: translate(-50%, -50%); z-index: 50; opacity: 0.8; }
        
        #blocker { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        #instructions { font-size: 24px; cursor: pointer; text-align: center; }

        #jumpscareScreen { display: none; position: absolute; width: 100%; height: 100%; background: black; z-index: 2000; background-image: url('jumpscare.png'); background-size: contain; background-repeat: no-repeat; background-position: center; }
        #endScreen { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #111; padding: 40px; border: 2px solid white; text-align: center; z-index: 2001; }
        
        /* Ukryty input do kod√≥w */
        #secretContainer { position: absolute; bottom: 10px; right: 10px; opacity: 0.3; }
        #secretCode { background: black; border: 1px solid gray; color: white; }
    </style>
</head>
<body>

    <div id="introWarning">
        <h1 style="color: red;">‚ö†Ô∏è OSTRZE≈ªENIE ‚ö†Ô∏è</h1>
        <p>Gra zawiera nag≈Çe, g≈Ço≈õne d≈∫wiƒôki.</p>
        <button id="acceptWarningBtn">WEJD≈π DO LASU</button>
    </div>

    <div id="jumpscareScreen"></div>

    <div id="ui">
        <div class="ui-item">üí∞ Monety: <span id="coinCount">0</span>/250</div>
        <div class="ui-item">üß© Przyciski: <span id="btnCount">0</span>/3</div>
        <div id="buffsContainer" style="margin-top: 10px; color: yellow;"></div>
    </div>

    <div id="blocker">
        <div id="instructions">
            <h1>PAUZA</h1>
            <p>Kliknij, aby wr√≥ciƒá do gry</p>
            <p style="font-size: 16px; color: gray;">WSAD - Ruch | SHIFT - Sprint | E - Interakcja</p>
        </div>
    </div>

    <div id="endScreen">
        <h1 style="color: gold;">UCIEK≈ÅE≈ö!</h1>
        <button onclick="location.reload()" style="padding: 10px 20px; font-size: 20px; cursor: pointer;">Zagraj Ponownie</button>
    </div>

    <div id="crosshair"></div>

    <div id="secretContainer">
        <input type="text" id="secretCode" placeholder="...">
        <button onclick="checkSecret()">OK</button>
    </div>

    <audio id="sndAmbient" src="ambient.mp3" loop></audio>
    <audio id="sndCrickets" src="crickets.mp3" loop></audio>
    <audio id="sndJumpscare" src="jumpscaresound.mp3"></audio>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/PointerLockControls.js"></script>

<script>
    // --- KONFIGURACJA ---
    const TREES_COUNT = 13000; // Gƒôsty las (PC)
    const BUSH_COUNT = 6000;
    
    let gameStarted = false;
    let isGameOver = false;
    let isSecretMode = false;
    let isAggro = false; // Czy bot goni
    
    // Gracz
    let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
    let canJump = false;
    let velocity = new THREE.Vector3();
    let direction = new THREE.Vector3();
    let isSprinting = false;
    let coinsCollected = 0;
    let buttonsFound = 0;

    // --- INIT THREE.JS ---
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x050505);
    scene.fog = new THREE.FogExp2(0x050505, 0.035); // Gƒôsta mg≈Ça

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 500);
    camera.position.set(0, 1.6, 0); // START GRACZA (≈öRODEK)

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    document.body.appendChild(renderer.domElement);

    // Controls
    const controls = new THREE.PointerLockControls(camera, document.body);
    const blocker = document.getElementById('blocker');
    const instructions = document.getElementById('instructions');

    instructions.addEventListener('click', function () { controls.lock(); });
    controls.addEventListener('lock', function () { blocker.style.display = 'none'; gameStarted = true; });
    controls.addEventListener('unlock', function () { if(!isGameOver) blocker.style.display = 'flex'; });

    // ≈öwiat≈Ço
    const ambientLight = new THREE.AmbientLight(0x101010); // Bardzo ciemno
    scene.add(ambientLight);
    
    // Latarka
    const flashlight = new THREE.SpotLight(0xffffff, 2.5, 40, Math.PI/4, 0.5, 1);
    flashlight.position.set(0, 0, 0);
    flashlight.target.position.set(0, 0, -1);
    camera.add(flashlight);
    camera.add(flashlight.target);
    scene.add(camera);

    // --- TEREN ---
    function getTerrainHeight(x, z) {
        return Math.sin(x / 15) * Math.cos(z / 15) * 2.5;
    }

    const texLoader = new THREE.TextureLoader();
    const floorTex = texLoader.load('https://threejs.org/examples/textures/terrain/grasslight-big.jpg');
    floorTex.wrapS = floorTex.wrapT = THREE.RepeatWrapping;
    floorTex.repeat.set(100, 100);

    const terrainGeo = new THREE.PlaneGeometry(1200, 1200, 256, 256);
    const pos = terrainGeo.attributes.position;
    for (let i = 0; i < pos.count; i++) {
        let x = pos.getX(i);
        let y = pos.getY(i);
        pos.setZ(i, getTerrainHeight(x, y));
    }
    terrainGeo.computeVertexNormals();
    const terrain = new THREE.Mesh(terrainGeo, new THREE.MeshStandardMaterial({ map: floorTex, color: 0x222222 }));
    terrain.rotation.x = -Math.PI / 2;
    scene.add(terrain);

    // --- RO≈öLINNO≈öƒÜ (INSTANCED MESH DLA OPTYMALIZACJI) ---
    const treeGeo = new THREE.CylinderGeometry(0.5, 0.8, 6, 8);
    const treeMat = new THREE.MeshStandardMaterial({ color: 0x0a0500 });
    const leafGeo = new THREE.ConeGeometry(3, 7, 8);
    const leafMat = new THREE.MeshStandardMaterial({ color: 0x001100 });

    const iTree = new THREE.InstancedMesh(treeGeo, treeMat, TREES_COUNT);
    const iLeaf = new THREE.InstancedMesh(leafGeo, leafMat, TREES_COUNT);
    const dummy = new THREE.Object3D();
    
    // Kolizje drzew (uproszczone)
    const treeCollisions = [];

    for(let i=0; i<TREES_COUNT; i++) {
        let x = (Math.random() - 0.5) * 1100;
        let z = (Math.random() - 0.5) * 1100;
        
        // Nie stawiaj drzew na spawnie (0,0)
        if(Math.abs(x) < 10 && Math.abs(z) < 10) { x += 20; }

        let y = getTerrainHeight(x, z);
        
        dummy.position.set(x, y + 3, z);
        dummy.rotation.y = Math.random() * Math.PI;
        dummy.updateMatrix();
        iTree.setMatrixAt(i, dummy.matrix);

        dummy.position.set(x, y + 7, z);
        dummy.updateMatrix();
        iLeaf.setMatrixAt(i, dummy.matrix);

        // Zapisz do kolizji (tylko te blisko gracza bƒôdƒÖ sprawdzane)
        // Optymalizacja: prosty grid? Tu dla prostoty tablica
        if (i % 3 === 0) treeCollisions.push({x:x, z:z, r:0.8}); 
    }
    scene.add(iTree);
    scene.add(iLeaf);

    // --- OBIEKTY INTERAKTYWNE ---
    const interactables = [];

    // 1. PRZYCISKI (3 sztuki, Po≈õwiata)
    function createButton(id) {
        const group = new THREE.Group();
        const box = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.5, 0.5), new THREE.MeshBasicMaterial({color: 0xff0000}));
        const glow = new THREE.PointLight(0xff0000, 2, 10); // ≈öwieci na 10 metr√≥w
        group.add(box);
        group.add(glow);
        
        let x = (Math.random()-0.5)*900;
        let z = (Math.random()-0.5)*900;
        group.position.set(x, getTerrainHeight(x,z) + 0.5, z);
        group.name = "btn";
        scene.add(group);
        interactables.push(group);
    }
    for(let i=0; i<3; i++) createButton(i);

    // 2. MONETY
    const coinGeo = new THREE.CylinderGeometry(0.3, 0.3, 0.1, 16);
    const coinMat = new THREE.MeshBasicMaterial({color: 0xffd700});
    const coinMeshes = [];
    for(let i=0; i<100; i++) {
        const coin = new THREE.Mesh(coinGeo, coinMat);
        coin.rotation.x = Math.PI/2;
        let x = (Math.random()-0.5)*800;
        let z = (Math.random()-0.5)*800;
        coin.position.set(x, getTerrainHeight(x,z)+1, z);
        coin.name = "coin";
        scene.add(coin);
        interactables.push(coin);
        coinMeshes.push(coin);
    }

    // 3. DRZWI
    const door = new THREE.Mesh(new THREE.BoxGeometry(2, 4, 0.2), new THREE.MeshStandardMaterial({color: 0xaaaaaa}));
    door.position.set(10, getTerrainHeight(10,10)+2, 10);
    door.visible = false;
    door.name = "door";
    scene.add(door);
    interactables.push(door);

    // --- NEXTBOT ---
    const botTex = texLoader.load('nextbot.jpg'); // Upewnij siƒô, ≈ºe masz ten plik
    const botMat = new THREE.SpriteMaterial({ map: botTex, color: 0xffffff });
    const nextbot = new THREE.Sprite(botMat);
    nextbot.scale.set(6, 6, 1);
    
    // FIX: SPAWN BOTA DALEKO OD GRACZA
    nextbot.position.set(300, 5, 300); 
    scene.add(nextbot);

    // Audio Nextbota
    const botAudioListener = new THREE.AudioListener();
    camera.add(botAudioListener); // Dodajemy listener do kamery
    const botSound = new THREE.PositionalAudio(botAudioListener);
    const audioLdr = new THREE.AudioLoader();
    audioLdr.load('nextbotsound.mp3', function(buffer) {
        botSound.setBuffer(buffer);
        botSound.setRefDistance(15);
        botSound.setLoop(true);
        nextbot.add(botSound);
    });

    // --- LOGIKA GRY ---
    
    // Obs≈Çuga Klawiszy
    document.addEventListener('keydown', (e) => {
        switch(e.code) {
            case 'ArrowUp': case 'KeyW': moveForward = true; break;
            case 'ArrowLeft': case 'KeyA': moveLeft = true; break;
            case 'ArrowDown': case 'KeyS': moveBackward = true; break;
            case 'ArrowRight': case 'KeyD': moveRight = true; break;
            case 'Space': if(canJump) { velocity.y += 12; canJump = false; } break;
            case 'ShiftLeft': isSprinting = true; break;
            case 'KeyE': interact(); break;
        }
    });
    document.addEventListener('keyup', (e) => {
        switch(e.code) {
            case 'ArrowUp': case 'KeyW': moveForward = false; break;
            case 'ArrowLeft': case 'KeyA': moveLeft = false; break;
            case 'ArrowDown': case 'KeyS': moveBackward = false; break;
            case 'ArrowRight': case 'KeyD': moveRight = false; break;
            case 'ShiftLeft': isSprinting = false; break;
        }
    });

    // Interakcja
    const raycaster = new THREE.Raycaster();
    function interact() {
        raycaster.setFromCamera(new THREE.Vector2(0,0), camera);
        const intersects = raycaster.intersectObjects(interactables, true);
        
        if(intersects.length > 0 && intersects[0].distance < 4) {
            const obj = intersects[0].object.parent.type === 'Scene' ? intersects[0].object : intersects[0].object.parent;
            
            if(obj.name === "btn") {
                scene.remove(obj);
                buttonsFound++;
                document.getElementById('btnCount').innerText = buttonsFound;
                if(buttonsFound >= 3) {
                    door.visible = true;
                    alert("DRZWI OTWARTE! (Znajd≈∫ szary prostokƒÖt blisko spawnu)");
                }
            } else if (obj.name === "coin") {
                scene.remove(obj);
                coinsCollected++;
                document.getElementById('coinCount').innerText = coinsCollected;
            } else if (obj.name === "door" && buttonsFound >= 3) {
                isGameOver = true;
                controls.unlock();
                document.getElementById('endScreen').style.display = 'block';
            }
        }
    }

    // Start Gry (Przycisk)
    document.getElementById('acceptWarningBtn').addEventListener('click', function() {
        document.getElementById('introWarning').style.display = 'none';
        
        // Start Audio
        const bgAudio = document.getElementById('sndCrickets');
        bgAudio.volume = 0.3;
        bgAudio.play();
        
        if(botSound.buffer) botSound.play();

        controls.lock();
    });

    // Sekret
    function checkSecret() {
        const val = document.getElementById('secretCode').value;
        if(val === "...") {
            isAggro = true;
            alert("TRYB CHAOSU W≈ÅƒÑCZONY");
        }
    }

    // --- PƒòTLA G≈Å√ìWNA ---
    let prevTime = performance.now();
    let botGracePeriod = 3.0; // 3 sekundy nietykalno≈õci bota

    function animate() {
        requestAnimationFrame(animate);
        
        if (!gameStarted || isGameOver) return;

        const time = performance.now();
        const delta = (time - prevTime) / 1000;
        prevTime = time;

        // 1. RUCH GRACZA
        velocity.x -= velocity.x * 10.0 * delta;
        velocity.z -= velocity.z * 10.0 * delta;
        velocity.y -= 30.0 * delta; // Grawitacja

        direction.z = Number(moveForward) - Number(moveBackward);
        direction.x = Number(moveRight) - Number(moveLeft);
        direction.normalize();

        const speed = isSprinting ? 60.0 : 35.0;

        if (moveForward || moveBackward) velocity.z -= direction.z * speed * delta;
        if (moveLeft || moveRight) velocity.x -= direction.x * speed * delta;

        controls.moveRight(-velocity.x * delta);
        controls.moveForward(-velocity.z * delta);
        camera.position.y += velocity.y * delta;

        // Kolizja z terenem
        let groundH = getTerrainHeight(camera.position.x, camera.position.z);
        if (camera.position.y < groundH + 1.6) {
            velocity.y = 0;
            camera.position.y = groundH + 1.6;
            canJump = true;
        }

        // Proste kolizje z drzewami
        for(let t of treeCollisions) {
            let dx = camera.position.x - t.x;
            let dz = camera.position.z - t.z;
            let dist = Math.sqrt(dx*dx + dz*dz);
            if(dist < t.r) {
                let push = (t.r - dist) / dist;
                camera.position.x += dx * push;
                camera.position.z += dz * push;
            }
        }

        // 2. LOGIKA NEXTBOTA
        if (botGracePeriod > 0) {
            botGracePeriod -= delta;
        } else {
            // Bot goni gracza
            let botSpeed = isAggro ? 14.0 : 6.0; // Normalna prƒôdko≈õƒá 6.0
            
            let vecToPlayer = new THREE.Vector3().subVectors(camera.position, nextbot.position);
            vecToPlayer.y = 0;
            vecToPlayer.normalize();
            
            nextbot.position.addScaledVector(vecToPlayer, botSpeed * delta);
            
            // Ustawienie bota na ziemi
            let botY = getTerrainHeight(nextbot.position.x, nextbot.position.z);
            nextbot.position.y = botY + 2.2;

            // Sprawdzenie przegranej (DYSTANS 2 METRY)
            if (nextbot.position.distanceTo(camera.position) < 2.0) {
                isGameOver = true;
                controls.unlock();
                document.getElementById('jumpscareScreen').style.display = 'block';
                document.getElementById('sndJumpscare').play();
                document.getElementById('sndCrickets').pause();
                if(botSound.isPlaying) botSound.stop();
                
                setTimeout(() => {
                    location.reload();
                }, 2500);
            }
        }

        // Animacja monet
        coinMeshes.forEach(c => c.rotation.y += delta * 2);

        renderer.render(scene, camera);
    }

    animate();

</script>
</body>
</html>
