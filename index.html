<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mroczny Las - FINAL FIXED</title>
    <style>
        body { margin: 0; overflow: hidden; background: black; font-family: 'Courier New', Courier, monospace; color: white; user-select: none; touch-action: none; }
        
        /* UI STARTOWE */
        #introWarning, #calibrationScreen { position: absolute; width: 100%; height: 100%; background: black; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        #acceptWarningBtn { pointer-events: auto; padding: 20px 40px; font-size: 20px; font-weight: bold; background: red; color: white; border: 2px solid white; cursor: pointer; border-radius: 10px; margin-top: 30px; }
        
        /* JUMPSCARE */
        #firstJumpscare, #gameJumpscare { display: none; position: absolute; width: 100%; height: 100%; background: black; z-index: 2000; background-size: contain; background-repeat: no-repeat; background-position: center; }
        #firstJumpscare { background-image: url('jumpscarefirst.gif'); }
        #gameJumpscare { background-image: url('jumpscare.png'); }

        /* MENU PAUZY / STARTU */
        #blocker { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        #instructions { font-size: 24px; cursor: pointer; text-align: center; padding: 20px; border: 1px solid white; background: rgba(0,0,0,0.5); border-radius: 10px; }

        /* HUD */
        #ui { position: absolute; top: 10px; left: 10px; z-index: 50; font-size: 18px; text-shadow: 2px 2px 2px black; pointer-events: none; }
        .buff-speed { color: yellow; display: none; }
        .buff-tracker { color: red; display: none; }
        .debuff-bush { color: purple; display: none; } 
        #crosshair { position: absolute; top: 50%; left: 50%; width: 10px; height: 10px; background: white; border-radius: 50%; transform: translate(-50%, -50%); z-index: 50; pointer-events: none; }

        /* MINIGRY & SKLEP */
        .overlay { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(20, 20, 20, 0.95); padding: 20px; border: 2px solid white; z-index: 200; text-align: center; border-radius: 10px; }
        #gdCanvas { border: 2px solid white; background: #222; margin-top: 10px; display: none; }
        #osuCanvas { border: 2px solid white; background: #111; margin-top: 10px; display: block; }
        input[type="text"] { background: black; color: white; border: 1px solid white; padding: 10px; }
        button { background: white; color: black; border: none; padding: 10px; margin: 5px; cursor: pointer; }

        /* STEROWANIE MOBILNE */
        #mobileControls { display: none; position: absolute; width: 100%; height: 100%; top: 0; left: 0; z-index: 150; pointer-events: none; }
        #joystickZone { position: absolute; bottom: 50px; left: 50px; width: 120px; height: 120px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); pointer-events: auto; }
        #joystickKnob { position: absolute; top: 50%; left: 50%; width: 40px; height: 40px; background: rgba(255, 255, 255, 0.5); border-radius: 50%; transform: translate(-50%, -50%); }
        #actionButtons { position: absolute; bottom: 30px; right: 30px; display: flex; gap: 15px; pointer-events: auto; flex-direction: column-reverse; align-items: flex-end; }
        .mob-btn { width: 60px; height: 60px; background: rgba(255, 255, 255, 0.2); border: 2px solid white; border-radius: 50%; color: white; font-size: 24px; display: flex; justify-content: center; align-items: center; user-select: none; }
        .mob-btn:active { background: rgba(255, 255, 255, 0.5); }
        .mob-btn-big { width: 80px; height: 80px; font-size: 35px; background: rgba(255, 0, 0, 0.3); }
        #lookZone { position: absolute; top: 0; right: 0; width: 50%; height: 70%; z-index: 140; pointer-events: auto; }
    </style>
</head>
<body>

    <div id="introWarning">
        <h1 style="color: red;">‚ö†Ô∏è OSTRZE≈ªENIE ‚ö†Ô∏è</h1>
        <p>Ta gra zawiera g≈Ço≈õne d≈∫wiƒôki i jumpscare'y.</p>
        <button id="acceptWarningBtn">ROZPOCZNIJ</button>
    </div>

    <div id="calibrationScreen" style="display: none;">
        <h2>Krok 1: Kalibracja</h2>
        <p>Podkrƒôƒá g≈Ço≈õno≈õƒá...</p>
        <p style="margin-top: 30px; color: gray;">≈Åadowanie: <span id="calibTimer">0</span>%</p>
    </div>

    <div id="firstJumpscare"></div>
    <div id="gameJumpscare"></div>

    <div id="ui">
        <div>üí∞ Monety: <span id="coinCount">0</span>/250</div>
        <div>üß© Przyciski: <span id="btnCount">0</span>/3</div>
        <div id="buffsContainer">
            <div id="uiSpeed" class="buff-speed">‚ö° Szybko≈õƒá: <span id="speedTimeText">0</span>s</div>
            <div id="uiTracker" class="buff-tracker">üëÅÔ∏è Lokalizator: <span id="trackerTimeText">0</span>s</div>
            <div id="uiBushCD" class="debuff-bush">üö´ Krzaki: <span id="bushTimeText">0</span>s</div>
        </div>
    </div>

    <div id="mobileControls">
        <div id="joystickZone"><div id="joystickKnob"></div></div>
        <div id="actionButtons">
            <div class="mob-btn" id="btnJump">‚¨ÜÔ∏è</div>
            <div class="mob-btn mob-btn-big" id="btnInteract">üñêÔ∏è</div>
            <div class="mob-btn" id="btnSprint">üèÉ</div>
        </div>
    </div>
    <div id="lookZone"></div>
    <div id="crosshair"></div>

    <div id="blocker">
        <div id="instructions">
            <h1 id="mainTitle">Mroczny Las</h1>
            <p style="color: yellow;">[ KLIKNIJ ABY GRAƒÜ ]</p>
            <div id="secretInput">
                <input type="text" id="secretCode" placeholder="Kod..." maxlength="5">
                <button onclick="checkSecret()">OK</button>
            </div>
        </div>
    </div>

    <div id="puzzle1" class="overlay"><h2>Zagadka #1</h2><p>D≈∫wiƒôk!</p><input type="text" id="ans1"><button onclick="solvePuzzle1()">OK</button><p id="timer1" style="color:red;">20</p></div>
    <div id="puzzle2" class="overlay"><h2>Zagadka #2</h2><video id="puzzleVideo" width="200" height="150" controls></video><input type="text" id="ans2"><button onclick="solvePuzzle2()">OK</button><p id="timer2" style="color:red;">20</p></div>
    <div id="puzzle3" class="overlay"><h2>Zagadka #3</h2><canvas id="gdCanvas" width="300" height="200"></canvas><button id="startGdBtn" onclick="startGD()">Start</button><p id="timer3" style="color:red;"></p></div>
    <div id="osuOverlay" class="overlay"><h2 style="color: lime;">Cicho!</h2><p>Trafiaj!</p><p>Celno≈õƒá: <span id="osuAcc">100</span>%</p><canvas id="osuCanvas" width="300" height="400"></canvas></div>
    <div id="shop" class="overlay"><h2>Sklep</h2><p>Monety: <span id="shopCoins">0</span></p><button onclick="buySpeed()">Szybko≈õƒá (10g)</button><button onclick="buyTracker()">Lokalizator (10g)</button><button onclick="closeShop()">Wyjd≈∫</button></div>
    <div id="endScreen" class="overlay"><h1 id="endTitle">KONIEC</h1><p id="endSubtitle"></p><button onclick="location.reload()">Reset</button></div>

    <audio id="sndCrickets" src="crickets.mp3" loop preload="auto"></audio>
    <audio id="sndFakeJumpscare" src="jumpscarefirstsound.mp3" preload="auto"></audio>
    <audio id="sndRealJumpscare" src="jumpscaresound.mp3" preload="auto"></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/PointerLockControls.js"></script>

<script>
// --- KONFIGURACJA URZƒÑDZENIA ---
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

// USTAWIENIA OPTYMALIZACJI
// Je≈õli Mobile: 2000 drzew, 1000 krzak√≥w. Je≈õli PC: 13000 drzew, 6000 krzak√≥w.
const TREE_COUNT = isMobile ? 2000 : 13000;
const BUSH_COUNT = isMobile ? 1000 : 6000;

if (isMobile) {
    document.getElementById('mobileControls').style.display = 'block';
    // Fix dla mobile touch events
    document.body.addEventListener('touchmove', function(e) { e.preventDefault(); }, { passive: false });
}

// --- SETUP STARTOWY ---
let introFinished = false;
let gameStarted = false;

// Klikniƒôcie w Ostrze≈ºenie rozpoczyna kalibracjƒô
document.getElementById('acceptWarningBtn').addEventListener('click', () => {
    document.getElementById('introWarning').style.display = 'none';
    startCalibration();
});
// Dla pewno≈õci na mobile (touch)
document.getElementById('acceptWarningBtn').addEventListener('touchstart', (e) => {
    e.preventDefault();
    document.getElementById('introWarning').style.display = 'none';
    startCalibration();
});

// LOGIKA KALIBRACJI (NAPRAWIONA: 15 SEKUND)
function startCalibration() {
    document.getElementById('calibrationScreen').style.display = 'flex';
    // Pr√≥ba odpalenia audio (wymagane przez przeglƒÖdarki)
    let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
    
    let c = document.getElementById('sndCrickets');
    c.volume = 0.1; 
    c.play().catch(e => console.log("Audio play error:", e));

    let percent = 0;
    // Interval 150ms * 100 krok√≥w = ok. 15 sekund
    let interval = setInterval(() => {
        // Losowy przyrost 0-2%
        percent += Math.random() * 1.5;
        if (percent >= 100) {
            percent = 100;
            clearInterval(interval);
            finishCalibration();
        }
        document.getElementById('calibTimer').innerText = Math.floor(percent);
    }, 150);
}

function finishCalibration() {
    document.getElementById('sndCrickets').pause();
    document.getElementById('calibrationScreen').style.display = 'none';
    document.getElementById('firstJumpscare').style.display = 'block';
    
    let scream = document.getElementById('sndFakeJumpscare');
    scream.volume = 1.0;
    scream.play().catch(e => console.log(e));

    setTimeout(() => {
        document.getElementById('firstJumpscare').style.display = 'none';
        scream.pause();
        scream.currentTime = 0;
        document.getElementById('blocker').style.display = 'flex';
        introFinished = true;
        animate(); // Start pƒôtli renderowania
    }, 2000);
}

// --- ROZPOCZƒòCIE ROZGRYWKI (NAPRAWIONE) ---
function startGame() {
    if (!introFinished) return;
    if (isHiding) return;

    // Odpalenie d≈∫wiƒôk√≥w Three.js
    if (audioListener.context.state === 'suspended') audioListener.context.resume();
    if (isAmbientLoaded && !ambientAudio.isPlaying) ambientAudio.play();
    if (isBotAudioLoaded && !nextbotAudio.isPlaying) nextbotAudio.play();

    if (isMobile) {
        // Mobile: Bez PointerLock, po prostu ukryj menu
        document.getElementById('blocker').style.display = 'none';
        gameStarted = true;
    } else {
        // PC: Wymu≈õ PointerLock
        controls.lock();
    }
}

document.getElementById('instructions').addEventListener('click', startGame);
document.getElementById('instructions').addEventListener('touchstart', (e) => { e.preventDefault(); startGame(); });

// PC Only Events
controls.addEventListener('lock', () => {
    document.getElementById('blocker').style.display = 'none';
    if(isSecretMode && !gameWon) showWarningText();
    gameStarted = true;
});
controls.addEventListener('unlock', () => {
    if(!gameWon && introFinished && !isHiding && !isMobile) {
        if(document.getElementById('puzzle1').style.display !== 'block') {
            document.getElementById('blocker').style.display = 'flex';
        }
    }
});

// --- THREE.JS SETUP ---
const scene = new THREE.Scene(); scene.background = new THREE.Color(0x000000); scene.fog = new THREE.FogExp2(0x000000, 0.035);
const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 300); camera.position.y = 1.5;

// RENDERER - OPTYMALIZACJA
const renderer = new THREE.WebGLRenderer({ antialias: !isMobile }); // Antyaliasing tylko na PC
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(isMobile ? 1 : window.devicePixelRatio); // 1x pixeli na mobile dla FPS
renderer.shadowMap.enabled = !isMobile; // Cienie tylko na PC
document.body.appendChild(renderer.domElement);

const controls = new THREE.PointerLockControls(camera, document.body);
const audioListener = new THREE.AudioListener(); camera.add(audioListener);
const audioLoader = new THREE.AudioLoader(); 
const ambientAudio = new THREE.Audio(audioListener);
const nextbotAudio = new THREE.PositionalAudio(audioListener); 
const agroAudio = new THREE.Audio(audioListener); 

let isAmbientLoaded = false; let isBotAudioLoaded = false;
let assets = { nextbotImg: 'nextbot.jpg', nextbotSound: 'nextbotsound.mp3', agroSound: 'agro.mp3', puzzle1Sound: 'zagadka1.mp3', puzzle2Video: 'wideo.mp4', ambientSound: 'ambient.mp3' };

audioLoader.load(assets.ambientSound, (b) => { ambientAudio.setBuffer(b); ambientAudio.setLoop(true); ambientAudio.setVolume(0.15); isAmbientLoaded=true; });
audioLoader.load(assets.nextbotSound, (b) => { nextbotAudio.setBuffer(b); nextbotAudio.setRefDistance(20); nextbotAudio.setLoop(true); nextbotAudio.setVolume(1.0); isBotAudioLoaded=true; });
audioLoader.load(assets.agroSound, (b) => { agroAudio.setBuffer(b); agroAudio.setLoop(true); });

// TERRAIN
const textureLoader = new THREE.TextureLoader();
const floorTexture = textureLoader.load('https://threejs.org/examples/textures/terrain/grasslight-big.jpg');
floorTexture.wrapS = floorTexture.wrapT = THREE.RepeatWrapping; floorTexture.repeat.set(50, 50);
function getTerrainHeight(x, z) { return Math.sin(x/15) * Math.cos(z/15) * 2; }
const terrain = new THREE.Mesh(new THREE.PlaneGeometry(1200, 1200, 100, 100), new THREE.MeshStandardMaterial({ map: floorTexture, color: 0x333333 }));
const pos = terrain.geometry.attributes.position;
for(let i=0; i<pos.count; i++) pos.setZ(i, getTerrainHeight(pos.getX(i), pos.getY(i)));
terrain.geometry.computeVertexNormals(); terrain.rotation.x = -Math.PI/2; scene.add(terrain);

const ambientLight = new THREE.AmbientLight(0x111111); scene.add(ambientLight);
const flashlight = new THREE.SpotLight(0xffffff, 0, 40, Math.PI/5, 0.3, 1);
flashlight.position.set(0,0,0); flashlight.target.position.set(0,0,-1);
camera.add(flashlight); camera.add(flashlight.target); scene.add(camera);

// OBIEKTY
const interactables = [];
const treeCollisionGrid = {}; function getGridKey(x, z) { return Math.floor(x/20)+"_"+Math.floor(z/20); }

// DRZEWA (Ilo≈õƒá zale≈ºna od urzƒÖdzenia)
const treeGeo = new THREE.CylinderGeometry(0.4, 0.6, 6, 6); const treeMat = new THREE.MeshStandardMaterial({color: 0x1a0f00});
const leafGeo = new THREE.ConeGeometry(2.5, 6, 6); const leafMat = new THREE.MeshStandardMaterial({color: 0x001a00});
const iTrunk = new THREE.InstancedMesh(treeGeo, treeMat, TREE_COUNT);
const iLeaf = new THREE.InstancedMesh(leafGeo, leafMat, TREE_COUNT);
const dummy = new THREE.Object3D();

for(let i=0; i<TREE_COUNT; i++) {
    let x = (Math.random()-0.5)*1100; let z = (Math.random()-0.5)*1100; let y = getTerrainHeight(x,z);
    let k = getGridKey(x,z); if(!treeCollisionGrid[k]) treeCollisionGrid[k]=[]; treeCollisionGrid[k].push({x:x,z:z,r:0.6});
    dummy.position.set(x, y+2.5, z); dummy.rotation.y = Math.random()*3; dummy.updateMatrix(); iTrunk.setMatrixAt(i, dummy.matrix);
    dummy.position.set(x, y+7, z); dummy.updateMatrix(); iLeaf.setMatrixAt(i, dummy.matrix);
}
scene.add(iTrunk); scene.add(iLeaf);

// PRZYCISKI Z LASERAMI
function createButton(id) {
    const g = new THREE.Group();
    const base = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.1, 0.8), new THREE.MeshStandardMaterial({color: 0x333333})); g.add(base);
    const btn = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.2, 0.5), new THREE.MeshStandardMaterial({color: 0xff0000, emissive: 0x550000})); btn.position.y=0.15; g.add(btn);
    // LASER
    const beam = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 400, 8), new THREE.MeshBasicMaterial({color: 0xff0000, opacity: 0.6, transparent: true})); beam.position.y=200; g.add(beam);
    let x = (Math.random()-0.5)*1000; let z = (Math.random()-0.5)*1000;
    g.position.set(x, getTerrainHeight(x,z)+0.05, z); g.name = "button"+id; scene.add(g); interactables.push(g);
}
for(let i=1; i<=3; i++) createButton(i);

const door = new THREE.Mesh(new THREE.BoxGeometry(2, 4, 0.2), new THREE.MeshStandardMaterial({color: 0xcccccc})); 
door.position.set(300, getTerrainHeight(300,300)+2, 300); door.visible=false; door.name="door"; scene.add(door); interactables.push(door);

// NEXTBOT
let nextbotMat = new THREE.SpriteMaterial({color: 0xffffff}); let nextbot = new THREE.Sprite(nextbotMat);
nextbot.renderOrder=999; nextbot.scale.set(6,6,1); nextbot.position.set(200,0,200); scene.add(nextbot); nextbot.add(nextbotAudio);
textureLoader.load(assets.nextbotImg, (t) => { nextbotMat.map = t; let ar = t.image.width/t.image.height; nextbot.scale.set(6*ar, 6, 1); });

// --- GAMEPLAY VARS ---
let isSecretMode=false; let gameWon=false; let hasFlashlight=false; let buttonsFound=0; let coinsCollected=0; let isAggro=false;
let speedTimeLeft=0; let trackerTimeLeft=0; let speedMult=1.0; let bushCooldownTime=0; let isHiding=false;
let velocity = new THREE.Vector3(); let moveForward=false; let moveBackward=false; let moveLeft=false; let moveRight=false; let isSprinting=false; let canJump=false; let velocityY=0; const gravity=-30.0; const jumpStrength=12.0;
let extraNextbots = [];

// --- SECRETS ---
function checkSecret() {
    let val = document.getElementById('secretCode').value;
    if(val === "...") { isAggro=true; alert("CHAOS MODE ACTIVATED"); for(let i=0; i<9; i++) { let c = nextbot.clone(); c.position.set((Math.random()-0.5)*1000, 0, (Math.random()-0.5)*1000); scene.add(c); extraNextbots.push(c); } }
    if(val === "81ZJA") { isSecretMode=true; assets.nextbotImg='nextbot2.png'; textureLoader.load(assets.nextbotImg, (t)=>{nextbotMat.map=t;}); alert("SECRET MODE"); }
}

// --- TOUCH CONTROLS ---
const joystickZone = document.getElementById('joystickZone'); const joystickKnob = document.getElementById('joystickKnob');
let joystickCenter = {x:0, y:0};
joystickZone.addEventListener('touchstart', (e)=>{ e.preventDefault(); const r=joystickZone.getBoundingClientRect(); joystickCenter={x:r.left+r.width/2, y:r.top+r.height/2}; handleJoy(e.touches[0]); });
joystickZone.addEventListener('touchmove', (e)=>{ e.preventDefault(); handleJoy(e.touches[0]); });
joystickZone.addEventListener('touchend', (e)=>{ e.preventDefault(); joystickKnob.style.top='50%'; joystickKnob.style.left='50%'; moveForward=moveBackward=moveLeft=moveRight=false; });
function handleJoy(t) {
    const dx = t.clientX - joystickCenter.x; const dy = t.clientY - joystickCenter.y;
    const dist = Math.min(Math.sqrt(dx*dx+dy*dy), 60); const ang = Math.atan2(dy, dx);
    joystickKnob.style.left = (50 + (Math.cos(ang)*dist/60)*50) + '%'; joystickKnob.style.top = (50 + (Math.sin(ang)*dist/60)*50) + '%';
    moveForward = dy < -15; moveBackward = dy > 15; moveLeft = dx < -15; moveRight = dx > 15;
}
document.getElementById('btnJump').addEventListener('touchstart', (e)=>{e.preventDefault(); if(canJump){velocityY=jumpStrength;canJump=false;}});
document.getElementById('btnInteract').addEventListener('touchstart', (e)=>{e.preventDefault(); interact();});
document.getElementById('btnSprint').addEventListener('touchstart', (e)=>{e.preventDefault(); isSprinting=true;});
document.getElementById('btnSprint').addEventListener('touchend', (e)=>{e.preventDefault(); isSprinting=false;});

// LOOK CONTROLS (MOBILE)
let lastTouchX=0; let lastTouchY=0;
document.getElementById('lookZone').addEventListener('touchstart', (e)=>{lastTouchX=e.touches[0].clientX; lastTouchY=e.touches[0].clientY;});
document.getElementById('lookZone').addEventListener('touchmove', (e)=>{
    if(!gameStarted) return;
    const dx = e.touches[0].clientX - lastTouchX; const dy = e.touches[0].clientY - lastTouchY;
    camera.rotation.y -= dx * 0.005; camera.rotation.x -= dy * 0.005;
    lastTouchX = e.touches[0].clientX; lastTouchY = e.touches[0].clientY;
});

// PC KEYS
document.addEventListener('keydown', (e)=>{ if(!introFinished)return; switch(e.code){ case 'KeyW':moveForward=true;break; case 'KeyS':moveBackward=true;break; case 'KeyA':moveLeft=true;break; case 'KeyD':moveRight=true;break; case 'ShiftLeft':isSprinting=true;break; case 'KeyE':interact();break; case 'Space':if(canJump){velocityY=jumpStrength;canJump=false;}break; } });
document.addEventListener('keyup', (e)=>{ switch(e.code){ case 'KeyW':moveForward=false;break; case 'KeyS':moveBackward=false;break; case 'KeyA':moveLeft=false;break; case 'KeyD':moveRight=false;break; case 'ShiftLeft':isSprinting=false;break; } });

// --- INTERAKCJA ---
const raycaster = new THREE.Raycaster();
function interact() {
    raycaster.setFromCamera(new THREE.Vector2(0,0), camera);
    const intersects = raycaster.intersectObjects(interactables, true);
    if(intersects.length > 0 && intersects[0].distance < 4) {
        let obj = intersects[0].object; while(obj.parent && obj.parent.type !== 'Scene') obj = obj.parent;
        if(obj.name.includes("button")) { 
            if(!isMobile) controls.unlock(); scene.remove(obj); buttonsFound++; 
            document.getElementById('btnCount').innerText = buttonsFound; 
            if(buttonsFound>=3) door.visible=true; 
            document.getElementById('puzzle1').style.display='block'; 
        }
        else if(obj.name==="door" && buttonsFound>=3) winGame();
        else if(obj.name==="hidingBush") { if(bushCooldownTime>0) alert("Zablokowane"); else startOsuGame(); }
        else if(obj.name==="npc") { if(!isMobile) controls.unlock(); document.getElementById('shop').style.display='block'; }
        else if(obj.name==="coin") { coinsCollected++; document.getElementById('coinCount').innerText=coinsCollected; scene.remove(obj); }
        else if(obj.name==="flashlight" && !hasFlashlight) { hasFlashlight=true; flashlight.intensity=2.5; scene.remove(obj); }
    }
}

// --- MINIGRY I SKLEP (LOGIKA UPROSZCZONA) ---
function winGame() { gameWon=true; if(!isMobile) controls.unlock(); document.getElementById('endScreen').style.display='block'; }
function closeShop() { document.getElementById('shop').style.display='none'; if(!isMobile) controls.lock(); }
function buySpeed() { if(coinsCollected>=10) { coinsCollected-=10; speedTimeLeft=60; closeShop(); } }
function buyTracker() { if(coinsCollected>=10) { coinsCollected-=10; trackerTimeLeft=10; closeShop(); } }
function solvePuzzle1() { document.getElementById('puzzle1').style.display='none'; if(!isMobile) controls.lock(); }
function solvePuzzle2() { document.getElementById('puzzle2').style.display='none'; if(!isMobile) controls.lock(); }
function startGD() { document.getElementById('puzzle3').style.display='none'; if(!isMobile) controls.lock(); }
// OSU
let osuActive=false;
function startOsuGame() { isHiding=true; osuActive=true; document.getElementById('osuOverlay').style.display='block'; if(!isMobile) controls.unlock(); requestAnimationFrame(osuLoop); }
function osuLoop() { if(!osuActive) return; requestAnimationFrame(osuLoop); } 
// Proste wyj≈õcie z OSU po klikniƒôciu (dla uproszczenia kodu)
document.getElementById('osuCanvas').addEventListener('click', ()=>{ osuActive=false; isHiding=false; document.getElementById('osuOverlay').style.display='none'; if(!isMobile) controls.lock(); });

function triggerRealJumpscare() { 
    gameWon=false; if(!isMobile) controls.unlock(); 
    document.getElementById('gameJumpscare').style.display='block'; 
    setTimeout(()=>{ document.getElementById('gameJumpscare').style.display='none'; document.getElementById('endScreen').style.display='block'; }, 2000); 
}

// --- PƒòTLA GRY ---
let prevTime = performance.now();
function animate() {
    requestAnimationFrame(animate); 
    const time = performance.now(); const delta = (time - prevTime) / 1000; prevTime = time;

    // UI Updates
    if(speedTimeLeft>0) { speedTimeLeft-=delta; speedMult=2.0; document.getElementById('uiSpeed').style.display='block'; document.getElementById('speedTimeText').innerText=Math.ceil(speedTimeLeft); } 
    else { speedMult=1.0; document.getElementById('uiSpeed').style.display='none'; }
    if(trackerTimeLeft>0) { trackerTimeLeft-=delta; nextbotMat.depthTest=false; document.getElementById('uiTracker').style.display='block'; document.getElementById('trackerTimeText').innerText=Math.ceil(trackerTimeLeft); } 
    else { nextbotMat.depthTest=true; document.getElementById('uiTracker').style.display='none'; }

    // Logic
    if ((controls.isLocked || (isMobile && gameStarted)) && !isHiding) {
        let speed = (isSprinting ? 50.0 : 30.0) * speedMult;
        
        if (isMobile) {
            // Mobile Movement (Manual Vector Calculation)
            let mf = 0; let mr = 0;
            if(moveForward) mf = speed * delta; if(moveBackward) mf = -speed * delta;
            if(moveLeft) mr = -speed * delta; if(moveRight) mr = speed * delta;
            
            const fwd = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion); fwd.y=0; fwd.normalize();
            const rgt = new THREE.Vector3(1,0,0).applyQuaternion(camera.quaternion); rgt.y=0; rgt.normalize();
            
            camera.position.addScaledVector(fwd, mf);
            camera.position.addScaledVector(rgt, mr);
        } else {
            // PC Movement
            velocity.x -= velocity.x * 10.0 * delta; velocity.z -= velocity.z * 10.0 * delta;
            let dirZ = Number(moveForward)-Number(moveBackward); let dirX = Number(moveRight)-Number(moveLeft);
            if(moveForward||moveBackward) velocity.z -= dirZ * speed * delta; 
            if(moveLeft||moveRight) velocity.x -= dirX * speed * delta;
            controls.moveRight(-velocity.x * delta); controls.moveForward(-velocity.z * delta);
        }

        // Gravity
        velocityY += gravity * delta; camera.position.y += velocityY * delta;
        let gh = getTerrainHeight(camera.position.x, camera.position.z);
        if (camera.position.y < gh + 1.6) { camera.position.y = gh + 1.6; velocityY = 0; canJump = true; }

        // Bot Logic
        let botSpeed = isAggro ? (isSecretMode ? 30 : 10) : (isSecretMode ? 14 : 4.5);
        const moveBot = (bot) => {
            let dir = new THREE.Vector3().subVectors(camera.position, bot.position); dir.y=0; dir.normalize();
            bot.position.addScaledVector(dir, botSpeed * delta);
            bot.position.y = getTerrainHeight(bot.position.x, bot.position.z) + 2.2;
            if(bot.position.distanceTo(camera.position) < 2) triggerRealJumpscare();
        };
        moveBot(nextbot); extraNextbots.forEach(b => moveBot(b));
    }

    renderer.render(scene, camera);
}
</script>
</body>
</html>
